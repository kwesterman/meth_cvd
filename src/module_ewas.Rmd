---
output:
  bookdown::pdf_document2:
    fig_caption: true
    keep_tex: true
    toc: false
    latex_engine: pdflatex
bibliography: ../doc/module_ewas/module_ewas_refs.bib
csl: bmcart.csl
link-citations: true
---

```{r prereqs, include=F}
library(knitr)
knitr::opts_chunk$set(echo=F, fig.path="../doc/module_ewas/figures/", 
                      cache.path="../cache/module_ewas/", fig.pos="h")
suppressMessages(silent <- lapply(
  c("tidyverse", "minfi", "survival", "kableExtra", "doParallel", "itertools",
    "gridExtra", "cowplot", "readxl", "flashpcaR", "coxme",
    "IlluminaHumanMethylation450kanno.ilmn12.hg19"), 
  library, character.only=T))
```

```{r load-data}
# Load methylation data
betas_whi <- readRDS("../int/betas.qc.norm.filt_whi.rds")
betas_fhs <- readRDS("../int/betas.qc.norm.filt_fhs.rds")

# Load metadata
metaData <- readRDS("../int/metaData.rds")

# Load estimated cell counts
est_cell_counts_whi <- readRDS("../int/est_cell_counts_whi.rds")
est_cell_counts_fhs <- readRDS("../int/est_cell_counts_fhs.rds")

# Load CPACOR principal component adjustment factors
load("../int/CPACOR_whi.RData")
CP_PCs_whi <- CP_PCs
load("../int/CPACOR_fhs.RData")
CP_PCs_fhs <- CP_PCs

# Load PCA results
load("../int/PCA.fit_whi.RData")
PCs_whi <- PCs
load("../int/PCA.fit_fhs.RData")
PCs_fhs <- PCs

# Generate Illumina 450k annotation data frame
anno_450k <- data.frame(getAnnotation(
  IlluminaHumanMethylation450kanno.ilmn12.hg19), stringsAsFactors=F)
```

```{r clean-data, warning=F}
est_cell_counts <- bind_rows(est_cell_counts_whi, est_cell_counts_fhs)
CP_PCs <- bind_rows(CP_PCs_whi, CP_PCs_fhs)
PCs <- bind_rows(PCs_whi, PCs_fhs)

# Create master covariate/event data frame
non_meth_data <- Reduce(function(x,y) inner_join(x, y, by="sampleKey"),
                        list(metaData, est_cell_counts, CP_PCs, PCs)) %>%
  distinct(subjID, .keep_all=T)  # Removal of biological replicates
non_meth_data <- replace_na(non_meth_data, 
                            list(bmi=median(non_meth_data$bmi, na.rm=T),
                                 smk_now=0, smk_py=0, 
                                 ht_med=0, lipid_med=0, dm_med=0)) %>%
  mutate(diabetes=(dm_med | glu > 125)) %>%
  mutate_at(c("chol", "ldl", "hdl", "tg", "sbp", "glu", "hscrp"), log10)

nmd_whi <- filter(non_meth_data, study == "whi")
nmd_fhs <- filter(non_meth_data, study == "fhs")

betas_whi <- betas_whi[, match(nmd_whi$sampleKey, colnames(betas_whi))]
betas_fhs <- betas_fhs[, match(nmd_fhs$sampleKey, colnames(betas_fhs))]
stopifnot(all(colnames(betas_whi) == nmd_whi$sampleKey),
          all(colnames(betas_fhs) == nmd_fhs$sampleKey))
```

\begin{flushleft}
{\Large
\textbf\newline{DNA methylation modules associate with incident cardiovascular disease and cumulative risk factor exposure}
}
\newline
% Insert author names, affiliations and corresponding author email (do not include titles, positions, or degrees).
\\
Kenneth Westerman\textsuperscript{1},
Paola Sebastiani\textsuperscript{2},
Paul Jacques\textsuperscript{1},
Simin Liu\textsuperscript{3},
Dawn DeMeo\textsuperscript{4},
Jos\'e M. Ordov\'as\textsuperscript{1,5,6*}
\\
\bigskip
\textbf{1} JM-USDA Human Nutrition Research Center on Aging at Tufts University, Boston, MA, USA
\\
\textbf{2} Department of Biostatistics, Boston University School of Public Health, Boston, MA, USA
\\
\textbf{3} Department of Epidemiology, Brown University, Providence, RI, USA
\\
\textbf{4} Channing Division of Network Medicine, Department of Medicine, Brigham and Women's Hospital, Boston, MA, USA
\\
\textbf{5} IMDEA Alimentaci\'on, CEI, UAM, Madrid, Spain
\\
\textbf{6} Centro Nacional de Investigaciones Cardiovasculares (CNIC), Madrid, Spain
\\
\bigskip

* jose.ordovas@tufts.edu

\end{flushleft}

# Abstract

**Background**
Epigenome-wide association studies using DNA methylation have the potential to uncover novel biomarkers and mechanisms of cardiovascular disease (CVD) risk. However, the direction of causation for these associations is not always clear, and investigations to-date have generally failed to replicate at the level of individual loci. Here, we undertook module- and region-based DNA methylation analyses of incident CVD in the Women's Health Initiative (WHI) and Framingham Heart Study Offspring Cohort (FHS) in order to find more robust epigenetic biomarkers for cardiovascular risk.

**Methods and Findings**
We applied weighted gene correlation network analysis (WGCNA) and the Comb-p algorithm to find methylation modules and regions associated with incident CVD in the WHI dataset. We discovered two modules whose activation correlated with CVD risk and replicated across cohorts. One of these modules was enriched for development-related processes and overlaps strongly with epigenetic aging sites. For the other, we showed preliminary evidence for monocyte-specific effects and statistical links to cumulative exposure to traditional cardiovascular risk factors. Additionally, we found three regions (associated with the genes SLC9A1, SLC1A5, and TNRC6C) whose methylation associates with CVD risk.

**Conclusions**
In sum, we present several epigenetic associations with incident CVD that reveal disease mechanisms related to development and monocyte biology. Furthermore, we show that epigenetic modules may act as a molecular readout of cumulative cardiovascular risk factor exposure, with implications for the improvement of clinical risk prediction.

# Introduction

Genetic approaches to cardiovascular disease (CVD) research have led to important breakthroughs in mechanistic understanding and therapeutic strategies. However, the mechanisms for gene variant-disease relationships are often difficult to determine, and their effects may often be mediated by epigenetic regulation [@Bonder2016]. DNA methylation is one such mechanism that can reflect both genetic variation and environmental exposures and potentially drive their effects on CVD outcomes [@Ordovas2010].

A series of recent epigenome-wide association studies (EWAS) have examined relationships between DNA methylation at cytosine-phosphate-guanine (CpG) sites and various subtypes of CVD, including prior myocardial infarction [@Rask-Andersen2016], acute coronary syndrome [@Li2017], and atherosclerosis [@Nakatochi2017]. These cross-sectional studies may reveal important mechanistic insights, but are susceptible to reverse causation, i.e. methylation being influenced by the presence of CVD. Indeed, Mendelian randomization approaches across multiple phenotypes have suggested that reverse causation is more common [@Dekkers2016; @Wahl2017] than the causal methylation effect that is often implicitly assumed. One approach to this problem is to examine epigenetic associations with cardiovascular risk factors. Multiple investigations have explored these relationships genome-wide [@Pfeiffer2015; @Irvin2014], and have even uncovered prognostic CpG sites for incident coronary heart disease in the process [@Hedman2017; @Aslibekyan2018]. A few studies looking directly at incident CVD as a binary variable have found relationships with global DNA methylation (as approximated by LINE-1 methylation levels) and with a specific cluster of CpG sites in the ZBTB12 gene [@Baccarelli2010; @Guarrera2015].

Studies linking CVD and methylation have additionally shown a notable lack of replication, especially at the level of single CpG sites [@Fernandez-Sanles2017]. One approach to this problem is to aggregate CpGs and test their phenotype associations at the group level. Differentially methylated region (DMR) searches may improve detection by combining sites based on physical proximity on the genome [@Jaffe2012; @Pedersen2012]. An alternative grouping strategy is to search for correlation-based clusters, which may boost biological signal and improve the interpretability of results [@Zhang2005]. This approach was originally developed for use with gene expression data, but has been successfully applied to higher-dimensional DNA methylation microarray datasets [@Horvath2012; @Busch2016].

To address the problem of reverse causation by CVD while achieving more robust results, we set out to analyze relationships between group-level CpG methylation and incident CVD using time-to-event models in two cohorts. We used module- and region-based techniques to improve detection and provide more interpretable results. We sought context for two specific modules of interest using gene- and chromatin-based annotations, and compared module activations to past and current cardiovascular risk factor levels to better understand their potential biological mechanisms.

# Results

## Weighted correlation network approach finds CVD-related modules

Population characteristics are described in Table 1. The discovery set, Women's Health Initiative (n=2023), had a median age of 65 at blood draw and is entirely female, while being selected for an approximately equal ratio of subjects who did and did not experience an incident CVD event following the methylation measurement timepoint. The replication set, Framingham Heart Study Offspring Cohort (n=2587), had a median age of 66 at blood draw (Exam 8) and is approximately half female, with 305 subjects experiencing incident CVD events. Cardiovascular events were defined here as encompassing coronary heart disease, stroke, and death from CVD (see Methods section for further details).

```{r population-description}
iq_range <- function(x) quantile(x, c(0.25, 0.75))

pop_data <- non_meth_data %>%
  dplyr::select(study, sex, age, race, bmi, smk_now, smk_py, 
                pastEvent, event) %>%
  group_by(study) %>%
  summarise(n=n(),
            perc_female=paste(round(sum(sex == "F") / n * 100), "%"),
            age_range=paste0(median(age), " (", 
                             paste(iq_range(age),collapse="-"), ")"),
            mixed_race=ifelse(length(unique(race)) > 1, "Yes", "No"),
            bmi_range=paste0(round(median(bmi), 1), " (", 
                             paste(round(iq_range(bmi), 1), collapse="-"), ")"),
            perc_smoke=paste0(round(sum(smk_now) / n * 100), "%"),
            smoking_pack_years=paste0(round(median(smk_py), 1), " (",
                                      paste(round(iq_range(smk_py), 1),
                                            collapse="-"), ")"),
            n_pastEvent=sum(pastEvent),
            n_event=sum(event)) %>%
  setNames(c("Dataset", "Sample Size", "% female", "Age at blood draw", 
             "Mixed race", "BMI", "% smoke currently", "Smoking pack-years",
             "# prior CVD events", "# incident CVD events")) %>%
  t() %>%
  data.frame() %>%
  setNames(c("FHS", "WHI"))

kable(pop_data[-1, c(2, 1)], caption="Population description", booktabs=T) %>%
  footnote(number=c("Continuous values shown as: median (interquartile range).",
                    "92 subjects experienced both prior and incident CVD events."))
```

```{r wgcna-load}
net <- readRDS("../int/wgcna/whi_net.rds")
whi_MEs <- readRDS("../int/wgcna/whi_MEs.rds")
mp <- readRDS("../int/wgcna/fhs_MP.rds")

# Helpful objects for downstream analysis -- module constituents, sizes, etc.
wgcna_input_cpgs <- rownames(betas_whi)
cpg_to_module <- data.frame(CpG=wgcna_input_cpgs, module=net$colors, 
                          stringsAsFactors=F)
mod_cpgs <- lapply(setNames(unique(net$colors),unique(net$colors)), function(m) wgcna_input_cpgs[net$colors==m])
mod_sizes <- cpg_to_module %>%
  group_by(module) %>%
  summarise(modSize=n())
```

We first set out to find biologically relevant modules in an unsupervised manner (agnostic to incident CVD information) using the WGCNA algorithm for `r nrow(betas_whi)` CpGs in WHI passing quality control filters (study overview in Supp. Fig. S1). After weighted correlation network construction, topological overlap calculation, and subsequent clustering, `r length(mod_cpgs)` modules were uncovered, ranging in size from `r min(mod_sizes$modSize)` to `r sort(mod_sizes$modSize, decreasing=T)[2]` CpGs.

```{r module-associations, include=F}
whi_mod_res_ccAdj_list <- lapply(whi_MEs$eigengenes, function(eg) {
  cox_fit <- coxph(Surv(time,event) ~ eg+dnaPull+CD4T+CD8T+Bcell+Mono+NK+Gran, 
                   data=nmd_whi)
  ph_check <- cox.zph(cox_fit)
  summary(cox_fit)$coef["eg", c("coef", "z", "Pr(>|z|)")]
})
whi_mod_res_ccAdj_df <- do.call(rbind, whi_mod_res_ccAdj_list) %>%
  as.data.frame() %>%
  rownames_to_column(var="module") %>%
  dplyr::rename(p=`Pr(>|z|)`) %>%
  mutate(module=gsub("^ME", "", module),
         fdr=p.adjust(p, method="BH")) %>%
  arrange(p)
top_modules <- whi_mod_res_ccAdj_df$module[whi_mod_res_ccAdj_df$fdr<0.2]

whi_mod_res_allAdj_list <- lapply(whi_MEs$eigengenes, function(eg) {
  cox_fit <- coxph(Surv(time,event) ~ eg+dnaPull+CD4T+CD8T+Bcell+Mono+NK+Gran+age+race+bmi+smk_now+smk_py,
                   data=nmd_whi)
  ph_check <- cox.zph(cox_fit)
  summary(cox_fit)$coef["eg", c("coef", "z", "Pr(>|z|)")]
})
whi_mod_res_allAdj_df <- do.call(rbind, whi_mod_res_allAdj_list) %>%
  as.data.frame() %>%
  rownames_to_column(var="module") %>%
  dplyr::rename(p=`Pr(>|z|)`) %>%
  mutate(module=gsub("^ME", "", module),
         fdr=p.adjust(p, method="BH")) %>%
  arrange(p)
```

```{r module-enrichments, cache=1, include=F}
module_go_enrichments <- lapply(
  setNames(top_modules, top_modules), 
  function(mod) {
    cpg_set <- mod_cpgs[[mod]]
    suppressWarnings(gsaTbl <- missMethyl::gometh(cpg_set, collection="GO"))
    gsaTopResTbl <- arrange(filter(gsaTbl, FDR < 0.25), FDR)
  })
```

```{r modules-ecs, cache=1, include=F}
whi_ECs <- list()
whi_EC2s <- list()
fhs_ECs <- list()
fhs_EC2s <- list()
ec_res <- lapply(setNames(top_modules, top_modules), function(mod) {
  pca.fit <- flashpca(scale(t(betas_whi[mod_cpgs[[mod]], ])), stand="sd", do_loadings=T)
  pc1rots <- setNames(pca.fit$loadings[,1], mod_cpgs[[mod]])
  pc1rots <- pc1rots * sign(lm(event ~ pca.fit$vectors[, 1]+CD4T+CD8T+Bcell+NK+Mono+Gran, data=nmd_whi)$coef[2])  # Aligns PC1 w/ CVD risk
  pc2rots <- setNames(pca.fit$loadings[,2], mod_cpgs[[mod]])
  pc2rots <- pc2rots * sign(lm(event ~ pca.fit$vectors[, 2]+CD4T+CD8T+Bcell+NK+Mono+Gran, data=nmd_whi)$coef[2])  # Aligns PC2 w/ CVD risk
  fhsCommonCpgs <- intersect(rownames(betas_fhs), names(pc1rots))
  list(whi_EC1=as.vector(scale(t(betas_whi[names(pc1rots), ])) %*% pc1rots), 
       whi_EC1_varExpl=var(pca.fit$projection[, 1]),
       whi_EC2=as.vector(scale(t(betas_whi[names(pc2rots), ])) %*% pc2rots), 
       whi_EC2_varExpl=var(pca.fit$projection[, 2]),
       whi_EVs=pca.fit$values,
       fhs_EC1=as.vector(scale(t(betas_fhs[fhsCommonCpgs, ])) %*% pc1rots[fhsCommonCpgs]),
       fhs_EC2=as.vector(scale(t(betas_fhs[fhsCommonCpgs, ])) %*% pc2rots[fhsCommonCpgs]))
})
whi_ECs <- map(ec_res, "whi_EC1")
fhs_ECs <- map(ec_res, "fhs_EC1")
whi_EC2s <- map(ec_res, "whi_EC2")
fhs_EC2s <- map(ec_res, "fhs_EC2")
whi_screeplots <- map(ec_res, "whi_scree")
```

```{r cpg-module-membership, eval=F}
cpg_module_membership <- as.data.frame(cor(t(betas_whi[mod_cpgs$brown4, ]), 
                                         whi_ECs$brown4))
MMP_value = as.data.frame(WGCNA::corPvalueStudent(
  as.matrix(cpg_module_membership), nrow(nmd_whi)))
```

```{r genome-distribution, cache=1, include=F}
summarise_annotation <- function(group, df) {
  # Takes in a set of annotations and returns the proportions of a given field (e.g. gene name)
  df %>%
    select(one_of("Name", group)) %>%
    separate_rows(group, sep=";") %>%
    distinct() %>%
    filter_at(group, all_vars(.!="")) %>%
    group_by_at(group) %>%
    summarise(n=n()) %>%
    mutate(frac=n/sum(n))
}

calc_enrichment_p <- function(mod_cpgs, bg_cpgs, type, group, lower_tail=F) {
  rti_summary_mod <- summarise_annotation(type, filter(anno_450k, 
                                                       Name %in% mod_cpgs))
  rti_summary_all <- summarise_annotation(type, filter(anno_450k, 
                                                       Name %in% bg_cpgs))
  n_hits_in_group <- sum(rti_summary_mod$n[rti_summary_mod[[type]] %in% group])
  n_avail_in_group <- sum(rti_summary_all$n[rti_summary_all[[type]] %in% group])
  2 * phyper(n_hits_in_group, n_avail_in_group, 
             length(wgcna_input_cpgs) - n_avail_in_group, length(mod_cpgs), 
             lower.tail=lower_tail)
}

gene_groups <- unique(unlist(strsplit(anno_450k$UCSC_RefGene_Group, 
                                      split=";")))
island_groups <- unique(unlist(strsplit(anno_450k$Relation_to_Island, 
                                        split=";")))
loc_enrichments <- rbind(
  cbind(expand.grid(module=top_modules, group=gene_groups, 
                    type="UCSC_RefGene_Group")),
  cbind(expand.grid(module=top_modules, group=island_groups, 
                    type="Relation_to_Island")))
loc_enrichments$p <- apply(
  loc_enrichments, 1, 
  function(r) calc_enrichment_p(mod_cpgs[[r[['module']]]], 
                                wgcna_input_cpgs, r[['type']], r[['group']]))
```

```{r fhs-rep, include=F}
Z_summary_pres <- mp$preservation$Z$ref.whi$inColumnsAlsoPresentIn.fhs[(
  top_modules), "Zsummary.pres"]

fhs_mod_res_list <- lapply(fhs_ECs, function(eg) {
  cox_fit <- coxph(Surv(time, event) ~ eg + center + cpPC1 + cpPC2 + cpPC3 + cpPC4 + cpPC5 + cpPC6 + cpPC7 + CD4T + CD8T + Bcell + Mono + NK + Gran, data=nmd_fhs)
  ph_check <- cox.zph(cox_fit)
  summary(cox_fit)$coef["eg", c("coef", "z", "Pr(>|z|)")]
})
fhs_mod_res_df <- do.call(rbind, fhs_mod_res_list) %>%
  as.data.frame() %>%
  rownames_to_column(var="module") %>%
  dplyr::rename(p=`Pr(>|z|)`) %>%
  mutate(module=gsub("^ME", "", module),
         fdr=p.adjust(p, method="BH")) %>%
  arrange(p)

fhs_mod_res_allAdj_list <- lapply(fhs_ECs, function(eg) {
  cox_fit <- coxph(Surv(time, event) ~ eg + center + cpPC1 + cpPC2 + cpPC3 + cpPC4 + cpPC5 + cpPC6 + cpPC7 + CD4T + CD8T + Bcell + Mono + NK + Gran + age + sex + bmi + smk_now + smk_py, data=nmd_fhs)
  ph_check <- cox.zph(cox_fit)
  summary(cox_fit)$coef["eg",c("coef", "z", "Pr(>|z|)")]
})

fhs_mod_res_allAdj_df <- do.call(rbind, fhs_mod_res_allAdj_list) %>%
  as.data.frame() %>%
  rownames_to_column(var="module") %>%
  dplyr::rename(p=`Pr(>|z|)`) %>%
  mutate(module=gsub("^ME", "", module),
         fdr=p.adjust(p, method="BH")) %>%
  arrange(p)

fhs_mod_res_peAdj_list <- lapply(fhs_ECs, function(eg) {
  cox_fit <- coxph(Surv(time,event) ~ eg + center + cpPC1 + cpPC2 + cpPC3 + cpPC4 + cpPC5 + cpPC6 + cpPC7 + CD4T + CD8T + Bcell + Mono + NK + Gran+pastEvent, data=nmd_fhs)
  summary(cox_fit)$coef["eg",c("coef", "z", "Pr(>|z|)")]
})
fhs_mod_res_peAdj_df <- do.call(rbind, fhs_mod_res_peAdj_list) %>%
  as.data.frame() %>%
  rownames_to_column(var="module") %>%
  dplyr::rename(p=`Pr(>|z|)`) %>%
  mutate(module=gsub("^ME", "", module),
         fdr=p.adjust(p, method="BH")) %>%
  arrange(p)

fhs_mod_res_sexInt_list <- lapply(fhs_ECs, function(eg) {
  cox_fit <- coxph(Surv(time, event) ~ eg * sex + center + cpPC1 + cpPC2 + cpPC3 + cpPC4 + cpPC5 + cpPC6 + cpPC7 + CD4T + CD8T + Bcell + Mono + NK + Gran, data=nmd_fhs)
  summary(cox_fit)$coef["eg:sexM", c("coef", "z", "Pr(>|z|)")]
})

whi_mod_res_raceInt_list <- lapply(whi_ECs, function(eg) {
  cox_fit <- coxph(Surv(time, event) ~ eg * race + dnaPull + CD4T + CD8T + Bcell + Mono + NK + Gran, 
                   data=nmd_whi)
  summary(cox_fit)$coef[c("eg:racehispanic", "eg:racewhite"), 
                        c("coef", "z", "Pr(>|z|)")]
})
```

Principal component eigenvectors for each module were calculated in order to examine the characteristics of these modules as a whole. The first principal component of each module tended to explain approximately half of the total variance, while the rest contributed only small fractions (see Supp. Fig. S2 for selected Scree plots). Thus, these first eigenvectors, or "eigenCpGs", were subsequently used to describe module behavior. Cox proportional hazards models were used to assess the relationships between these module eigenCpGs and incident CVD. In partially-adjusted models (adjusted for technical factors and estimated white blood cell proportions), three modules were found to be associated at multiple test-corrected FDR < 0.2 (Table 2; correction based on 110 modules). Adjustment for biological covariates (age, BMI, sex/race, and smoking behavior) attenuated these relationships to marginal statistical significance (all 0.01 < p < 0.1; direct risk factor associations shown in Fig. 3). These modules showed strong (FDR < 10\textsuperscript{-4}) enrichment for different sets of GO terms, ranging from immune activation (myeloid or T cell) to developmental processes.

```{r sig-module-table, warning=F}
go_enrichments <- data.frame(module=top_modules,
                            `GO terms`=c("Development", "Immune activation",
                                         "T cell activation"))

sig_loc_enrichments <- data.frame(
  module=top_modules, 
  islandLocEnrich=c("N_shore", "Open sea", "Open sea"), 
  geneLocEnrich=c("1stExon/TSS/5' UTR", "", "Body"), stringsAsFactors=F)

module_var_expl <- whi_MEs$varExplained %>%
  setNames(gsub("^ME", "", names(whi_MEs$eigengenes))) %>%
  gather(key=module, value=varExpl)
modTbl <- mod_sizes %>%
  inner_join(module_var_expl, by="module") %>%
  inner_join(select(whi_mod_res_ccAdj_df, module, p), by="module") %>%
  inner_join(go_enrichments, by="module") %>%
  inner_join(sig_loc_enrichments, by="module") %>%
  mutate(varExpl=100 * varExpl,
         p=format.pval(p, 2), varExpl=round(varExpl, 2)) %>%
  arrange(p)
  
kable(setNames(modTbl, c("module", "size", "Var. expl. (%)", "p", "GO terms", 
                         "CpG Islands", "Gene-based")), booktabs=T,
      caption="Modules associated with incident CVD at FDR < 0.2") %>%
  add_header_above(c("", "", "EigenCpG"=2, "Enrichment analysis"=3))
```

All three modules showed very strong preservation in FHS (all $Z_{summary}$ statistics > 50, where 10 is a typical threshold for strong preservation), when evaluated using established density and connectivity preservation techniques [@Langfelder2011]. Of these, two associations with incident CVD (blue and brown4) replicated strongly in FHS, while lavenderblush3 showed nominal replication (p=`r format.pval(fhs_mod_res_df$p[3], 3)`) in partially-adjusted models (Supp. Table 1). Fully-adjusted models including age as a covariate attenuated (brown4) or abolished (blue and lavenderblush3) these associations in FHS.

Though the existence of past CVD events (experienced prior to sample collection for DNA methylation measurement) could represent a confounder in the FHS dataset, sensitivity analyses adjusting for past events did not appreciably reduce the strength of these module-trait relationships. Also of potential relevance to this replication is the demographic heterogeneity between the two cohorts. To address this possibility, we performed additional analyses including interaction terms between eigenCpGs for each module and either sex (in FHS) or race (in WHI). None of these analyses produced significant interaction terms at p < 0.05. 

```{r ica, eval=F}
brown4betas_whi <- betas_whi[mod_cpgs$brown4, ]
ica_fit <- fastICA(t(brown4betas_whi), n.comp=10)

icaRes_whi <- lapply(1:10, function(i) {
  ic <- ica_fit$S[, i]
  cox_fit <- coxph(Surv(time,event)~ic+dnaPull+CD4T+CD8T+Bcell+NK+Mono+Gran+age+bmi+smk_now+smk_py+race, data=nmd_whi)
  summary(cox_fit)$coef["ic", c("coef", "z", "Pr(>|z|)")]
})

icaRes_fhs <- lapply(1:10, function(i) {
  weights <- ica_fit$A[i, ]
  ic <- t(betas_fhs[mod_cpgs$brown4, ]) %*% weights
  cox_fit <- coxph(Surv(time,event)~ic+center+cpPC1+cpPC2+cpPC3+cpPC4+cpPC5+cpPC6+cpPC7+CD4T+CD8T+Bcell+Mono+NK+Gran+sex+age+bmi+smk_now+smk_py, data=nmd_fhs)
  summary(cox_fit)$coef["ic", c("coef", "z", "Pr(>|z|)")]
})

icaRes <- data.frame(whi=map_dbl(icaRes_whi, 3), fhs=map_dbl(icaRes_fhs, 3))
```

```{r module-annot-table, eval=F}
go_enrichment_strings <- c(blue="development", brown="immune+development",
                         lightgreen="development", brown4="immune",
                         blue2="none", lavenderblush3="immune (T cell-specific)",
                         darkolivegreen4="development", salmon="immune",
                         plum1="development")

module_annot_tbl <- ewas_module_enrichments %>%
  filter(module %in% top_modules) %>%
  mutate(GO_annot=go_enrichment_strings[module],
         pEnrich=format.pval(pEnrich)) %>%
  arrange(desc(obsOverExp)) %>%
  select(module, numHits, modSize, obsOverExp, pEnrich, GO_annot)
kable(module_annot_tbl, booktabs=T, caption="EWAS-enriched module annotation")
``` 

## Genome-wide associations between DNA methylation and incident CVD events

```{r qc, warning=F}
make_variation_plot <- function(cohort) {
  nmd <- filter(non_meth_data, study == cohort)
  
  wbcpca.fit <- prcomp(select(nmd, CD8T, CD4T, NK, Bcell, Mono, Gran), scale.=T)
  nmd$WBC_PC1 <- wbcpca.fit$x[, "PC1"]
  nmd$WBC_PC2 <- wbcpca.fit$x[, "PC2"]
  
  covs <- c("sex", "age", "race", "bmi", "smk_now", "smk_py", "WBC_PC1", 
            "WBC_PC2", "plate", "center", "dnaPull", "sentrixRow", "sentrixCol", 
            "event", "pastEvent")
  comparison_df <- expand.grid(pc=c(paste0("PC", 1:6), 
                                   "cpPC1", "cpPC2", "event"), covar=covs)
  
  comparison_df$negLogP <- apply(comparison_df, 1, function(row) {
    pc <- row["pc"]
    covar <- row["covar"]
    nlp <- tryCatch({
      lm_fit <- lm(as.formula(paste0(pc, "~", covar)), data=nmd)
      pVal <- anova(lm_fit)[covar, "Pr(>F)"]
      -log10(pVal)
    }, error=function(e) 0)
    if(is.na(nlp)) 0 else min(nlp, 20)
  })
  
  ggplot(comparison_df, aes(x=pc, y=forcats::fct_rev(covar), fill=negLogP)) +
    geom_tile(color="white") +
    scale_fill_gradient2(low='#0000FF',mid='#FFFFFF',high='#FF0000') +
    scale_x_discrete(position="top") +
    labs(title=toupper(cohort),
         caption="Note: -log(p-values) capped at 20 to aid visualization.") +
    theme(axis.title=element_blank())
}

whiVarPlt <- make_variation_plot("whi")
fhsVarPlt <- make_variation_plot("fhs")
```

```{r ewas-prep}
my_try <- function(expr, CpG) {
  # Captures model failures and returns successful result or vector of NAs
  tryCatch(expr, error=function (e) {
    print(e)
    c(CpG, rep(NA, 3))
    })
}

run_cox_model <- function(probe_data, covar_data, model_spec) {
  # Given a row of the M-value matrix, bind that methylation
  # data to the covariate data and run Cox proportional hazards regression
  # Args:
  #   probe_data: Methylation data for a specific CpG site
  #   covar_data: Covariate + event data frame (subjects should match probe_data)
  #   model_spec: String containing the model formula specification
  # Returns:
  #   A 1x3 matrix containing the regression coefficient, z-score and p-value 
  CpG <- rownames(probe_data)
  probe_data <- as.vector(probe_data)
  outlier_TF <- (probe_data < quantile(probe_data, 0.25) - 3 * IQR(probe_data) | 
    (probe_data > quantile(probe_data, 0.75) + 3 * IQR(probe_data)))
  model_data <- cbind(covar_data, meth=as.numeric(probe_data),
                      survObj=Surv(time=covar_data$time, event=covar_data$event))
  my_try({
    cox_fit <- coxph(as.formula(model_spec), data=model_data, subset =! outlier_TF)
    c(CpG=CpG, summary(cox_fit)$coef[c('meth'), c('coef', 'z', 'Pr(>|z|)')])
  }, CpG)
}

assess_ph <- function(probe_data, covar_data, model_spec) {
  # Given a row of the M-value matrix (corresponding to a CpG site), bind that methylation
  # data to the covariate data and use cox.zph function to evalute the proportional hazards assumption
  CpG <- rownames(probe_data)
  probe_data <- as.vector(probe_data)
  outlier_TF <- (probe_data < quantile(probe_data, 0.25) - 3 * IQR(probe_data) | 
    (probe_data > quantile(probe_data, 0.75) + 3 * IQR(probe_data)))
  model_data <- cbind(covar_data, meth=as.numeric(probe_data),
                     survObj=Surv(time=covar_data$time, event=covar_data$event))
  my_try({
    cox_fit <- coxph(as.formula(model_spec), data=model_data, 
                     subset=!outlier_TF)
    cox.zph(cox_fit)$table["meth", "p"]
  }, CpG)
}
```

```{r ewas-discovery, cache=1}
ewas_model_whi <- paste0("survObj ~ meth + age + race + bmi + smk_now + smk_py ",
                        "+ CD4T + CD8T + Bcell + NK + Mono + Gran + dnaPull")

cl <- makePSOCKcluster(detectCores())
registerDoParallel(cl)

whi_res_list <- foreach(meth=iter(betas_whi, by="row"), 
                        .packages="survival") %dopar%
  run_cox_model(meth, nmd_whi, ewas_model_whi)

stopCluster(cl)

whi_res <- do.call(rbind, whi_res_list) %>%
  data.frame(stringsAsFactors=F, check.names=F) %>%
  dplyr::rename(p=`Pr(>|z|)`) %>%
  mutate_at(c("coef", "z", "p"), as.numeric) %>%
  mutate(fdr=p.adjust(p, method="BH")) %>%
  arrange(p)
```

```{r ewas-replication, cache=1}
ewas_model_fhs <- paste0("survObj ~ meth + sex + age + bmi + smk_now + smk_py", 
                        " + CD4T + CD8T + Bcell + NK + Mono + Gran + center + ",
                        paste0("cpPC", 1:7, collapse="+"))

cl <- makePSOCKcluster(detectCores())
registerDoParallel(cl)

fhs_res_list <- foreach(meth=iter(betas_fhs, by="row"), 
                        .packages="survival") %dopar%
  run_cox_model(meth, nmd_fhs, ewas_model_fhs)

stopCluster(cl)

fhs_res <- do.call(rbind, fhs_res_list) %>%
  data.frame(stringsAsFactors=F, check.names=F) %>%
  dplyr::rename(p=`Pr(>|z|)`) %>%
  mutate_at(c("coef", "z", "p"), as.numeric) %>%
  mutate(fdr=p.adjust(p, method="BH")) %>%
  arrange(p)
```

```{r ewas-inflation}
make_qqplot <- function(p_vec, plotTitle="Title") {
  p_vec <- p_vec[!is.na(p_vec)]
  qqplot(-log10(1:length(p_vec) / length(p_vec)), -log10(p_vec), pch=".", 
         main=plotTitle, xlab="Expected (-logP)", ylab="Observed (-logP)")
  abline(0, 1, col="red")
}

gControl <- function(p_vals) {
  # See van Iterson 2017 methods and/or Lehne 2015 code for details on genomic control for EWAS
  # Below is modeled after Lehne 2015
  lambda <- median(qchisq(p_vals, df=1, lower.tail=F), 
                   na.rm=T) / qchisq(0.5, df=1)
  round(lambda, 2)
}
```

```{r ewas-discovery-investigation, warning=F}
qqman_input_whi <- whi_res %>%
  inner_join(select(anno_450k, Name, chr, pos), by=c("CpG"="Name")) %>%
  mutate(CHR=as.numeric(gsub("chr", "", chr)), BP=as.numeric(pos), 
         P=as.numeric(p)) %>%
  na.omit()

suppressMessages(
  whiPhChecks <- foreach(meth=iter(betas_whi[whi_res$CpG[1:100], ], by="row"), 
                         .packages="survival") %do%
    assess_ph(meth, non_meth_data[non_meth_data$study == "whi", ], 
              ewas_model_whi))
```

```{r top-hits, include=F}
bonferroni_threshold <- 0.05 / nrow(whi_res)
whi_to_fhs_replication <- whi_res %>%
  filter(p < bonferroni_threshold, !is.na(p)) %>%
  left_join(fhs_res, by="CpG", suffix=c(".whi", ".fhs"))
bonferroni_tbl <- whi_to_fhs_replication %>%
  select(-contains("z"), -contains("fdr"))
fdr_tbl <- whi_res %>%
  filter(fdr < 0.05) %>%
  mutate(direction=ifelse(sign(coef) == 1, "+", "-"),
         p=as.character(signif(p,3))) %>%
  inner_join(select(anno_450k, Name, chr, UCSC_RefGene_Group, 
                    UCSC_RefGene_Name), by=c("CpG"="Name")) %>%
  select(CpG, chr, direction, p, UCSC_RefGene_Group, UCSC_RefGene_Name)
```

To investigate more specific DNA methylation signals, we performed an epigenome-wide association study (EWAS) for incident CVD. Of single sites from the EWAS, `r nrow(whi_to_fhs_replication)` reached a genome-wide Bonferroni threshold, but none replicated strongly in FHS (Supp. Table 2). In order to improve statistical power, we focused on differentially methylated regions (DMRs) with respect to incident CVD status. Single-site EWAS p-values were used as input to the Comb-p algorithm, which seeks regions enriched for low p-values while accounting for autocorrelation based on genomic distance. Comb-p was applied separately to EWAS results from WHI and FHS.

```{r combp-prep}
res_to_bed <- function(res_df) {
  res_df %>%
    inner_join(anno_450k, by=c("CpG"="Name")) %>%
    mutate(chrom=chr, chromStart=pos - 1, chromEnd=pos, name=CpG) %>%  # Start at provided genomic coordinate - 1 (modeled after a script from Github)
    dplyr::select(chrom, chromStart, chromEnd, p, name) %>%
    filter(!is.na(p)) %>%
    arrange(chrom, chromStart)  # Order by chromosome/position
}

write_tsv(res_to_bed(whi_res), "../int/whiRes.bed")
write_tsv(res_to_bed(fhs_res), "../int/fhsRes.bed")
```

```{r combp-results, message=F}
combp_res_whi <- read_tsv("../int/regions.sig_whi.bed", col_names=F) %>%
  setNames(c("chr", "start", "end", "lowest_p", "num_cpgs", 
             "p_region_slk", "p_adj_region_sidak")) %>%
  mutate(p_adj_region=signif(
    pmin(p_region_slk * (nrow(whi_res) / num_cpgs), 1), 3)) %>%
  arrange(p_adj_region_sidak) %>%
  filter(p_adj_region_sidak < 0.05, num_cpgs >= 2)
combp_ranges_whi <- GRanges(combp_res_whi$chr, 
                            IRanges(combp_res_whi$start, combp_res_whi$end))
combp_res_fhs <- read_tsv("../int/regions.sig_fhs.bed", col_names=F) %>%
  setNames(c("chr", "start", "end", "lowest_p", "num_cpgs", 
             "p_region_slk", "p_adj_region_sidak")) %>%
  mutate(p_adj_region=signif(
    pmin(p_region_slk * (nrow(fhs_res) / num_cpgs), 1), 3)) %>%
  arrange(p_adj_region)
combp_ranges_fhs <- GRanges(combp_res_fhs$chr, 
                            IRanges(combp_res_fhs$start, combp_res_fhs$end))

region_to_cpgs <- function(dmrChr, start, end) {
  filter(anno_450k, chr==dmrChr, 
         pos>=as.numeric(start), pos<=as.numeric(end))$Name
}

all_dmr_cpgs <- apply(combp_res_whi, 1, function(r) {
  dmr_anno_cpgs <- region_to_cpgs(r["chr"], r["start"], r["end"])
  dmr_anno_cpgs[dmr_anno_cpgs %in% whi_res$CpG]
})
all_dmr_modules <- lapply(all_dmr_cpgs, function(cpg_set) {
  unique(cpg_to_module$module[cpg_to_module$CpG %in% cpg_set])
})
module_representation_in_dmrs <- combp_res_whi %>%
  mutate(modules=all_dmr_modules) %>%
  select(modules) %>%
  unnest(modules) %>%
  group_by(modules) %>%
  summarise(n=n()) %>%
  inner_join(mod_sizes, by=c("modules"="module")) %>%
  mutate(frac=n / modSize) %>%
  arrange(desc(frac))

overlap_ranges <- findOverlaps(combp_ranges_whi, combp_ranges_fhs)
combp_rep <- combp_res_whi %>%
  dplyr::slice(from(overlap_ranges)) %>%
  dplyr::select(chr, start, end, p_region_slk, p_adj_region_sidak) %>%
  cbind(p_region_slk_fhs=combp_res_fhs$p_region_slk[to(overlap_ranges)],
        p_adj_region_fhs=combp_res_fhs$p_adj_region_sidak[(
          to(overlap_ranges))]) %>%
  filter(p_adj_region_sidak < 0.05,
         p_region_slk_fhs < 0.05 / nrow(combp_res_whi))
all_rep_dmr_cpgs <- apply(combp_rep, 1, function(r) {
  dmr_anno_cpgs <- region_to_cpgs(r["chr"], r["start"], r["end"])
  dmr_anno_cpgs[dmr_anno_cpgs %in% whi_res$CpG]
})
all_rep_dmr_modules <- lapply(all_rep_dmr_cpgs, function(cpg_set) {
  cpg_to_module$module[cpg_to_module$CpG %in% cpg_set]
})

find_genes_by_region <- function(locDF) {
  apply(locDF, 1, function(row) {
    regionAnnot <- filter(anno_450k, chr == row["chr"], 
                          pos > as.numeric(row["start"]), 
                          pos <= as.numeric(row["end"]))
    gsub(";.*", "", regionAnnot$UCSC_RefGene_Name[1])
  })
}

combp_res_tbl <- combp_rep %>%
  mutate(annot_gene=find_genes_by_region(.),
         num_cpgs=lengths(all_rep_dmr_cpgs)) %>%
  mutate(loc=paste0(chr, ":", start, "-", end),
         gene_loc=c("Body", "CpG shelf near TSS", "CpG island in 5' UTR")) %>%
  mutate_at(vars(contains("p_")), function(p) as.character(signif(p, 3))) %>%
  select(chr, start, end, loc, num_cpgs, annot_gene, gene_loc, 
         p_region_slk, p_adj_region_sidak, p_region_slk_fhs)

combp_res_tbl_pretty <- combp_res_tbl %>%
  mutate_at(c("p_region_slk", "p_adj_region_sidak", "p_region_slk_fhs"), function(p) format.pval(as.numeric(p), digits=3)) %>%
  select(loc, num_cpgs, annot_gene, gene_loc, p_region_slk, p_adj_region_sidak, p_region_slk_fhs) %>%
  setNames(c("Location", "# CpGs", "Annotated gene", "Genomic region", "P", "Adj. P", "P"))
kable(combp_res_tbl_pretty, booktabs=T, 
      caption=paste("Comb-p regions with multiple test-corrected p<0.05",
                    "in WHI and Bonferroni p<0.05 in FHS")) %>%
  add_header_above(c("", "", "", "", "Discovery"=2, "Replication"))
```

206 DMRs were found in WHI after Sidak multiple testing correction for each DMR based on its length. Of these, 3 were both found in FHS and replicated at a Bonferroni level (Table 3; Fig. 1). These regions were annotated to two cellular transport genes (SLC9A1 and SLC1A5) and TNRC6C, which codes for a scaffolding protein involved in miRNA-mediated translational repression. Of the three WGCNA modules identified above, brown4 CpG sites consituted part of 2 DMRs (at SLC9A1 & SLC1A5), while a single CpG from the blue module was also a member of the SLC9A1 DMR.

```{r make-combp-plots, warning=F}
make_bed <- function(res_df) {
  res_df %>%
    inner_join(anno_450k, by=c("CpG"="Name")) %>%
    mutate(start=as.numeric(pos), 
           end=as.numeric(pos),
           negLogP=-log10(p)) %>%
    dplyr::select(chr, start, end, negLogP, CpG)
}

res_anno_whi <- make_bed(whi_res)
res_anno_fhs <- make_bed(fhs_res)

# SLC9A1 locus
dmr <- c(combp_res_tbl$start[1], combp_res_tbl$end[1])
chrom <- combp_res_tbl$chr[1]
chromstart <- dmr[1] - 5000
chromend <- dmr[2] + 5000
res_anno_region_whi <- filter(res_anno_whi, chr == chrom, 
                              start >= chromstart, end <= chromend)
res_anno_region_fhs <- filter(res_anno_fhs, chr == chrom, 
                              start >= chromstart, end <= chromend)
plot_df <- bind_rows(list(res_anno_region_whi, res_anno_region_fhs), 
                     .id="Dataset") %>%
  mutate(Dataset=case_when(Dataset == 1 ~ "WHI", Dataset == 2 ~ "FHS"),
         Dataset=factor(Dataset, levels=unique(Dataset)))
slc9a1_plt <- ggplot(plot_df, aes(x=start / 1000, y=negLogP, color=Dataset)) +
  geom_point(size=2) +
  geom_vline(xintercept=dmr[1] / 1000, linetype="dashed") +
  geom_vline(xintercept=dmr[2] / 1000, linetype="dashed") +
  xlab("Position on chr. 1 (kb)") +
  ggtitle("SLC9A1 locus")

# SLC1A5 locus
dmr <- c(combp_res_tbl$start[2], combp_res_tbl$end[2])
chrom <- combp_res_tbl$chr[2]
chromstart <- dmr[1] - 5000
chromend <- dmr[2] + 5000
res_anno_region_whi <- filter(res_anno_whi, chr == chrom, 
                              start >= chromstart, end <= chromend)
res_anno_region_fhs <- filter(res_anno_fhs, chr == chrom, 
                              start >= chromstart, end <= chromend)
plot_df <- bind_rows(list(res_anno_region_whi, res_anno_region_fhs), 
                     .id="Dataset") %>%
  mutate(Dataset=case_when(Dataset == 1 ~ "WHI", Dataset == 2 ~ "FHS"),
         Dataset=factor(Dataset, levels=unique(Dataset)))
slc1a5_plt <- ggplot(plot_df, aes(x=start / 1000, y=negLogP, color=Dataset)) + 
  geom_point(size=2) +
  geom_vline(xintercept=dmr[1] / 1000, linetype="dashed") +
  geom_vline(xintercept=dmr[2] / 1000, linetype="dashed") +
  xlab("Position on chr. 19 (kb)") +
  ggtitle("SLC1A5 locus")

# TNRC6C locus
dmr <- c(combp_res_tbl$start[3], combp_res_tbl$end[3])
chrom <- combp_res_tbl$chr[3]
chromstart <- dmr[1] - 5000
chromend <- dmr[2] + 5000
res_anno_region_whi <- filter(res_anno_whi, chr == chrom, 
                              start >= chromstart, end <= chromend)
res_anno_region_fhs <- filter(res_anno_fhs, chr == chrom, 
                              start >= chromstart, end <= chromend)
plot_df <- bind_rows(list(res_anno_region_whi, res_anno_region_fhs), 
                     .id="Dataset") %>%
  mutate(Dataset=case_when(Dataset == 1 ~ "WHI", Dataset == 2 ~ "FHS"),
         Dataset=factor(Dataset, levels=unique(Dataset)))
tnrc6c_plt <- ggplot(plot_df, aes(x=start / 1000, y=negLogP, color=Dataset)) + 
  geom_point(size=2) +
  geom_vline(xintercept=dmr[1]/1000, linetype="dashed") +
  geom_vline(xintercept=dmr[2]/1000, linetype="dashed") +
  xlab("Position on chr. 17 (kb)") +
  ggtitle("TNRC6C locus")
```

## Exploration of the brown4 and blue modules

```{r brown4-enrichments, warning=F}
whi_cpgs_annot <- anno_450k %>%
  mutate(Enhancer=ifelse(Enhancer == T, T, F)) %>%
  filter(Name %in% rownames(betas_whi))

annot_plot <- function(cpg_set, bg_cpg_set, group_var) {
  # Given a specific field, plot proportion of CpGs in a specific subset 
  # next to those of the full set
  my_groups <- summarise_annotation(
    group_var, filter(anno_450k, Name %in% cpg_set))
  all_groups <- summarise_annotation(
    group_var, filter(anno_450k, Name %in% bg_cpg_set))
  merge_groups <- inner_join(my_groups, all_groups, by=group_var, 
                             suffix=c(".subset", ".all")) %>%
    gather(key=group, value=frac, contains("frac")) %>%
    mutate(group=factor(group, levels=c("frac.all", "frac.subset"), 
                        labels=c("All CpGs", "Module CpGs")))
  ggplot(merge_groups, aes_string(x=group_var, y="frac", fill="group")) +
    geom_bar(stat="identity", position="dodge") +
    theme(axis.title.x=element_blank(), 
          axis.text.x=element_text(angle=35, hjust=1))
}

brown4_gene_group_enrichment_plot <- annot_plot(
  mod_cpgs$brown4, whi_cpgs_annot$Name, "UCSC_RefGene_Group")
brown4_cpg_island_enrichment_plot <- annot_plot(
  mod_cpgs$brown4, whi_cpgs_annot$Name, "Relation_to_Island")

p_body <- calc_enrichment_p(mod_cpgs$brown4, whi_cpgs_annot$Name, 
                            "UCSC_RefGene_Group", "Body", lower_tail=F)
p_opensea <- calc_enrichment_p(mod_cpgs$brown4, whi_cpgs_annot$Name, 
                               "Relation_to_Island", "OpenSea", lower_tail=F)

num_in_enh <- sum(whi_cpgs_annot$Enhancer[(
  whi_cpgs_annot$Name %in% mod_cpgs$brown4)] == T)
num_enh_tot <- sum(whi_cpgs_annot$Enhancer == T)
p_enhancers <- 2 * phyper(num_in_enh, num_enh_tot, 
                          nrow(whi_cpgs_annot) - num_enh_tot, 
                          length(mod_cpgs$brown4), lower.tail=F)

separateGeneAnno <- anno_450k %>%
  select(Name, UCSC_RefGene_Name) %>%
  separate_rows(UCSC_RefGene_Name, sep=";")

num_genes_brown4 <- length(unique(filter(
  separateGeneAnno, Name %in% mod_cpgs$brown4)$UCSC_RefGene_Name))
```

```{r blue-enrichments, warning=F}
blue_gene_group_enrichment_plot <- annot_plot(
  mod_cpgs$blue, whi_cpgs_annot$Name, "UCSC_RefGene_Group")
blue_cpg_island_enrichment_plot <- annot_plot(
  mod_cpgs$blue, whi_cpgs_annot$Name, "Relation_to_Island")

p_island <- calc_enrichment_p(mod_cpgs$blue, whi_cpgs_annot$Name, 
                              "Relation_to_Island", "Island", lower_tail=F)

num_genes_blue <- length(unique(filter(
  separateGeneAnno, Name %in% mod_cpgs$blue)$UCSC_RefGene_Name))
```

Based on the results from the module- and region-centric analyses, we investigated the brown4 and blue modules further for biological significance. The brown4 module was associated with immune-related genes as noted above, and was enriched strongly for "open sea" sites (p=1.1e-42) and annotated enhancers (p=1.7e-33). In contrast, the blue module was associated with development-related genes, and was enriched moderately for sites near genic transcription start sites and strongly for CpG islands (p < 2.2e-16) (Fig. 2a,b).

Given these observations, we examined relative enrichments of enhancer- and promoter-associated histone marks across different blood cell subtypes to better understand the cell type specificity of this signal. Epigenetic peaks were annotated using data from the Roadmap Epigenomics Project [@KundajeAnshulMeuleman2015] and relative enrichments were calculated as the fraction of module CpGs found in peaks divided by the fraction of all CpGs found in peaks.

```{r module-cell-type-corrs, eval=F}
mod_cell_type_corrs <- expand.grid(module=top_modules, 
                                   cellType=c("CD4T", "CD8T", "Bcell", 
                                              "Mono", "NK", "Gran"), 
                                   stringsAsFactors=F) %>%
  mutate(corr=map2_dbl(module, cellType, function(m,c) {
    cor.test(whi_ECs[[m]], nmd_whi[[c]])$estimate
  }))
mod_cell_type_corrs_wide <- mod_cell_type_corrs %>%
  spread(key=module, value=corr)
mod_clust <- hclust(dist(t(mod_cell_type_corrs_wide[-1])))
mod_order <- mod_clust$labels[mod_clust$order]

cell_type_corr_plt <- ggplot(filter(mod_cell_type_corrs, module == "brown4"), 
                             aes(x=module, y=cellType, fill=corr)) +
  geom_tile() +
  scale_fill_gradient2()

cell_type_corr_plt
```

```{r eforge-prep, message=F}
silent <- lapply(top_modules, function(m) {
  write(mod_cpgs[[m]], file=paste0("../int/", m, "_cpgs.txt"))
})
```

```{r eforge-res, message=F}
eforge_res_dhs <- read_tsv("../int/eforge_brown4_dhs.tsv")
eforge_res_histones <- read_tsv("../int/eforge_brown4_histones.tsv")
eforge_res <- bind_rows(eforge_res_dhs, eforge_res_histones) %>%
  filter(Tissue == "Blood") %>%
  dplyr::select(Cell, Datatype, Pvalue) %>%
  mutate(negLogP=-log10(Pvalue)) %>%
  filter(!grepl("cord", Cell)) %>%
  mutate(Cell=case_when(
    grepl("E050", Cell) ~ paste0("E050 Primary hematopoietic stem cells\n",
                                 "G-CSF-mobilized Female"),
    grepl("E051", Cell) ~ paste0("E050 Primary hematopoietic stem cells\n",
                                 "G-CSF-mobilized Male"),
    TRUE ~ Cell)) %>%
  filter(Datatype %in% c("DHS", "H3K4me1", "H3K4me3")) %>%
  arrange(desc(negLogP)) %>%
  mutate(Cell=factor(Cell, levels=unique(Cell)))

eforge_plt <- ggplot(eforge_res, aes(x=Datatype, y=Cell, fill=negLogP)) +
  geom_tile() +
  scale_fill_gradient2() +
  theme(axis.title=element_blank(), axis.text.x=element_text(angle=20))

eforge_cell_codes <- filter(eforge_res_dhs, Tissue == "Blood", 
                            !grepl("cord", Cell, ignore.case=T))$Accession
```

```{r my-roadmap-prep, cache=1, warning=F}
whi_anno_450k <- filter(anno_450k, Name %in% wgcna_input_cpgs)
whi_anno_450k_ranges <- GRanges(whi_anno_450k$chr, 
                                IRanges(start=whi_anno_450k$pos, 
                                        end=whi_anno_450k$pos))

read_epi_anno <- function(broad_peaks_file) {
  # Given a path to a broadPeaks annotation file, read in the set of regions and output a GRanges object
  epi_anno_df <- suppressMessages(read_tsv(broad_peaks_file, 
                                          col_names=F, progress=F)) %>%
    select(1, 2, 3, ncol(.)) %>%
    setNames(c("chr", "start", "end", "negLogQ")) %>%
    filter(negLogQ > 2)
  GRanges(seqnames=epi_anno_df$chr, 
          IRanges(start=epi_anno_df$start, end=epi_anno_df$end))
}

test_epi_anno <- function(epi_anno_gr, module) {
  # Given a set of peak calls/regions of interest for an 
  # epigenomic annotation of interest (as GRanges object), return the -log(p)
  # testing whether a set of EWAS results are associated with the annotation
  if(length(epi_anno_gr) == 0) return(NA)
  cpgs_in_anno <- findOverlaps(whi_anno_450k_ranges, epi_anno_gr)
  anno_with_membership_and_mods <- mutate(
    whi_anno_450k, 
    member=1:nrow(whi_anno_450k) %in% queryHits(cpgs_in_anno),
    inModule=Name %in% mod_cpgs[[module]])
  
  tryCatch({
    member_and_module <- sum(anno_with_membership_and_mods$member & 
                             anno_with_membership_and_mods$inModule)
    in_module <- sum(anno_with_membership_and_mods$inModule)
    member <- sum(anno_with_membership_and_mods$member)
    overall <- nrow(whi_res)
    log2((member_and_module / in_module) / (member / overall))
  },
  error=function(e) NA)
}

assemble_epi_anno <- function(anno_type, cell_type, module) {
  # Given an epigenomic annotation type (e.g. H3K4me1), 
  # output a named list of GRanges objects
  anno_dir <- paste0("../data/literature/roadmap/", anno_type)
  anno_file <- grep(cell_type, list.files(anno_dir, full.names=T), value=T)
  if (length(anno_file) == 0) {
    epi_anno_gr <- GRanges()
  } else {
    epi_anno_gr <- read_epi_anno(anno_file)
  }
  t_stat <- test_epi_anno(epi_anno_gr, module)
  data.frame(module=module, epiFeature=anno_type, 
             cellTypeCode=cell_type, negLogP=as.numeric(t_stat))
}

epi_features <- list.files("../data/literature/roadmap/", pattern="^[DH].*")
roadmap_meta <- read_csv(paste0("../data/literature/roadmap/jul2013.roadmap",
                                "Data.qc\ -\ Consolidated_EpigenomeIDs_QC.csv"), 
                         col_types=cols()) %>%
  dplyr::rename(cellType=`Standardised epigenome name`) %>%
  select(EID, cellType) %>%
  distinct()
cell_type_codes <- unique(gsub("^.*/|-.*", "", 
                               list.files("../data/literature/roadmap/", 
                                          recursive=T)))
feature_cell_grid <- expand.grid(epiFeature=epi_features, 
                                 cellTypeCode=cell_type_codes, 
                                 module=top_modules, 
                                 stringsAsFactors=F) %>%
  inner_join(roadmap_meta, by=c("cellTypeCode"="EID")) %>%
  # filter(grepl("^Primary.*peripheral|H1 Cell Line|H9 Cell Line|Ovary|Liver|Small Intestine|Spleen|^Thymus$", cellType, ignore.case=T),
  #        !grepl("Neuron", cellType, ignore.case=T)) %>%
  # filter(grepl("^Primary.*peripheral|^Primary hematopoietic|Liver|Spleen|^Thymus|Small Intestine", cellType, ignore.case=T)) %>%
  filter(cellTypeCode %in% eforge_cell_codes) %>%
  filter(epiFeature %in% c("DNase", "H3K4me1", "H3K4me3"), 
         module %in% c("brown4", "blue", "lavenderblush3"))

# cl <- makePSOCKcluster(detectCores())
# registerDoParallel(cl)
cell_type_NLPs <- foreach(anno=iter(feature_cell_grid, by="row"), 
                          .combine=rbind,
                          .packages=c("tidyverse", "GenomicRanges")) %do% 
  assemble_epi_anno(anno$epiFeature, anno$cellTypeCode, anno$module)
# stopCluster(cl)
```

```{r my-roadmap-plot-data, warning=F}
epi_anno_plt_data <- cell_type_NLPs %>%
  na.omit() %>%
  left_join(roadmap_meta, by=c("cellTypeCode"="EID")) %>%
  filter(module %in% c("brown4", "blue")) %>%
  group_by(cellType, module) %>%
  mutate(cellTypeAbsMean=mean(abs(negLogP), na.rm=T)) %>%
  ungroup() %>%
  arrange(desc(cellTypeAbsMean)) %>%
  mutate(cellType=factor(cellType, levels=unique(cellType)))
```

We observed the greatest enrichment of brown4 CpGs in 2 enhancer-associated chromatin annotations, DNase hypersensitivity sites (DHS) and H3K4me1 histone peaks, from monocytes compared to other blood cell subtypes (Fig. 2c). This could point towards monocyte-related biology and inflammatory processes as an important shared mechanism for cardiovascular risk between the two cohorts examined here. In contrast, blue CpGs were enriched for DHS and promoter-associated H3K4me3 histone peaks from hematopoietic stem cells (HSCs), providing a link to the observed enrichment of develoment-related genes in this set.

```{r horvath-overlap}
suppressMessages({
  dnam_age_df <- read_csv("../data/literature/horvath_dnamAge_cpgs.csv", skip=2)
  pheno_age_df <- read_csv("../data/literature/phenoAge.csv")
  hannum_df <- read_excel("../data/literature/hannum_cpgs.xlsx", sheet=1)
})
dnam_age_cpgs <- dnam_age_df$CpGmarker[-1]
pheno_age_cpgs <- pheno_age_df$CpG
hannum_cpgs <- hannum_df$Marker

age_metric_enrich_Ps_brown4 <- sapply(
  list(horvath=dnam_age_cpgs, pheno_age=pheno_age_cpgs, hannum=hannum_cpgs), 
  function(cpg_set) {
    num_in_set <- length(intersect(cpg_set, mod_cpgs$brown4))
    2 * phyper(num_in_set, length(cpg_set), nrow(whi_res) - length(cpg_set), 
               length(mod_cpgs$brown4), lower.tail=F)
  })
age_metric_enrich_Ps_blue <- sapply(
  list(horvath=dnam_age_cpgs, phenoAge=pheno_age_cpgs, hannum=hannum_cpgs), 
  function(cpg_set) {
    num_in_set <- length(intersect(cpg_set, mod_cpgs$blue))
    2 * phyper(num_in_set, length(cpg_set), nrow(whi_res) - length(cpg_set), 
               length(mod_cpgs$blue), lower.tail=F)
  })

horvath_overlap <- intersect(dnam_age_cpgs, mod_cpgs$blue)
horvath_positive <- dnam_age_df$CpGmarker[dnam_age_df$CoefficientTraining > 0]
horvath_overlap_positive <- intersect(horvath_overlap, horvath_positive)
```

```{r pcg-enrichment, warning=F}
suz12_df <- read_excel(
  "../../meth_cvd/data/literature/suz12_occupancies.xls", skip=2) %>%
  filter(!is.na(Chromosome)) %>%
  dplyr::slice(-3268)  # End position seems to be an error
suz12_ranges <- GRanges(seqnames=suz12_df$Chromosome,
                        IRanges(start=suz12_df$Start, end=suz12_df$End))
all_ranges <- GRanges(seqnames=gsub("chr", "", whi_cpgs_annot$chr),
                      IRanges(start=whi_cpgs_annot$pos, end=whi_cpgs_annot$pos))
blue_annot <- filter(whi_cpgs_annot, Name %in% mod_cpgs$blue)
blue_ranges <- GRanges(seqnames=gsub("chr", "", blue_annot$chr),
                       IRanges(start=blue_annot$pos, end=blue_annot$pos))

num_all_pcg_overlaps <- length(queryHits(findOverlaps(all_ranges, suz12_ranges)))
num_blue_pcg_overlaps <- length(queryHits(findOverlaps(blue_ranges, suz12_ranges)))
suz12_enrich_p <- 2 * phyper(num_blue_pcg_overlaps, 
                             num_all_pcg_overlaps, 
                             length(all_ranges) - num_all_pcg_overlaps, 
                             length(mod_cpgs$blue), 
                             lower.tail=F)
```

The module CpG sets were also compared to two existing methylation-based age predictors from Horvath and Hannum et al., as well as the recent morbidity-directed phenoAge [@Horvath2013; @Hannum2013; @Levine2018]. While enrichments for brown4 CpGs were moderate to nonexistent, blue CpGs were strongly enriched for all three of these sets, most highly for the original DNAm age developed by Horvath (`r length(horvath_overlap)`/353; p=3.4e-5; hypergeometric test), despite the fact that this model was developed based on only ~21,000 CpGs shared between multiple versions of the Illumina methylation microarray platform. Furthermore, `r length(horvath_overlap_positive)` of these `r length(horvath_overlap)` CpGs had associated positive coefficients in the DNAm age predictor. This subset has been previously observed to contain a disproportionate amount of Polycomb-group target genes, which are known to associate with developmental processes and to be generally hypermethylated with age [@Dozmorov2015]. Using SUZ12 binding regions [@Lee2006] as a proxy for Polycomb-group targets, we confirmed their enrichment in the blue module (p = `r as.character(signif(suz12_enrich_p, 3))`). Surprisingly, the blue eigenCpG showed only a modest correlation with age (r=0.09).

<!--
```{r blue-development-genes, message=F}
blue_cpgs_annot <- filter(whi_cpgs_annot, Name %in% mod_cpgs$blue)
blue_genes <- unlist(strsplit(blue_cpgs_annot$UCSC_RefGene_Name, ";"))

ad_genes <- scan("../data/literature/anatomical_development_genes.txt", 
                 what=character())
sd_genes <- scan("../data/literature/system_development_genes.txt", 
                 what=character())
mod_genes <- scan("../data/literature/multicellular_organism_development_genes.txt", 
                  what=character())

blue_dev_genes <- intersect(blue_genes, 
                            unique(c(ad_genes, sd_genes, mod_genes)))
  # Genes that correspond to blue CpGs and are in the top 3 enriched GO categories (development-related)

# allCpgPerGene <- anno_450k %>%
#   separate_rows(UCSC_RefGene_Name, sep=";") %>%
#   group_by(UCSC_RefGene_Name) %>%
#   summarise(nTot=n())
# blueCpgPerGene <- blue_cpgs_annot %>%
#   separate_rows(UCSC_RefGene_Name, sep=";") %>%
#   group_by(UCSC_RefGene_Name) %>%
#   summarise(n=n()) %>%
#   inner_join(allCpgPerGene, by="UCSC_RefGene_Name") %>%
#   mutate(frac=n/nTot) %>%
#   arrange(desc(frac))
# topBlueRepGenes <- blueCpgPerGene$UCSC_RefGene_Name[]
#   # Genes with the greatest proportion of their CpGs being a part of the blue module

blue_pca_fit <- flashpca(scale(t(betas_whi[mod_cpgs$blue, ])), 
                         stand="sd", do_loadings=T)
blue_loadings <- setNames(blue_pca_fit$loadings[, 1], mod_cpgs$blue)
topBlueCpgs <- mod_cpgs$blue[(
  abs(blue_loadings) > quantile(abs(blue_loadings), 0.9))]
row_sep_anno <- separate_rows(anno_450k, UCSC_RefGene_Name, sep=";")
top_blue_ec_genes <- unique(  # Genes corresponding to the CpGs with the strongest loadings in blue PC1
  row_sep_anno$UCSC_RefGene_Name[row_sep_anno$Name %in% topBlueCpgs])
  
dev_ME_regions <- read_excel("../data/literature/aat2624_Tables_S1_to_S5.xlsx", 
                             sheet=2, skip=1)
dev_ME_cpgs <- unlist(apply(dev_ME_regions, 1, function(row) region_to_cpgs(
  row[["Chromosome"]], row[["ME start"]], row[["ME end"]])))
dev_ME_genes <- unique(row_sep_anno$UCSC_RefGene_Name[(
  row_sep_anno$Name %in% dev_ME_cpgs)])

blue_priority_genes <- Reduce(intersect,
                            list(blue_dev_genes, top_blue_ec_genes, dev_ME_genes))
  # This intersection consists of genes annotated to blue module CpGs with high module 
  # importance statistics, in the top 3 dev-related GO terms, and annotated to environmentally
  # sensitive methylation states during development in Kessler et al. 2018
```

To find specific genes that may be relevant to the link between blue module methylation and CVD, a set of genes was assembled constituting the intersection between 1) genes in one of the top 3 enriched Gene Ontology terms for the blue module (anatomical development, system development, and multicellular organism development), 2) genes annotated to CpGs whose weights in the blue eigenCpG were in the top 10%, and  3) genes annotated to environmentally sensitive regions of DNA methylation in the human embryo as determined by a recent investigation [@Kessler2018]. Exactly one gene, PDE3A, belongs to all three categories. PDE3A codes for Phosphodiesterase 3A, and as a known gene related to cardiovascular risk and sensitive to early-life exposures, may represent one avenue by which the blue module is related to disease risk in adult life.
-->

## Module-risk factor relationships

```{r cumulative}
all_exams <- readRDS("../int/past_exam_data.rds") %>%
  mutate_at(setdiff(names(.), c("exam", "subjID", "bmi")), log10)

risk_factors <- rev(c("sbp", "chol", "ldl", "hdl", "tg", "hscrp", "glu", "bmi", 
                      "smk_now", "smk_py", "age"))

past_data <- lapply(paste0("exam", 1:7), 
                    function(ex) filter(all_exams, exam == ex))
names(past_data) <- paste0("exam", 1:7)
past_data$cumulative <- all_exams %>%
  select(-exam) %>%
  group_by(subjID) %>%
  summarise_all(mean, na.rm=T)
past_data$current <- select(nmd_fhs, subjID, risk_factors)

cum_data <- left_join(nmd_fhs, past_data$cumulative, by="subjID", 
                      suffix=c(".curr", ".cum"))
```

```{r risk-factor-correlations, warning=F}
mod_rf_corrs_whi <- expand.grid(module=top_modules, rf=risk_factors, 
                                stringsAsFactors=F) %>%
  mutate(corr=map2_dbl(module, rf, function(m,r) {
    nmd_whi$ec <- whi_ECs[[m]]
    ec_resids <- lm(ec~dnaPull, data=nmd_whi)$residuals
    cor.test(ec_resids, nmd_whi[[r]])$estimate
  })) %>%
  filter(module %in% c("brown4", "blue", "lavenderblush3"))

find_corrs_fhs <- function(exam_data, markers) {
  corr_data <- left_join(select(nmd_fhs, subjID, center), exam_data, by="subjID")
  expand.grid(module=top_modules, rf=markers, stringsAsFactors=F) %>%
    mutate(corr=map2_dbl(module, rf, function(m,r) {
      corr_data$ec <- fhs_ECs[[m]]
      ec_resids <- lm(ec~center, data=corr_data)$residuals
      tryCatch(cor.test(ec_resids, corr_data[[r]])$estimate,
               error=function(e) NA)
    }))
}

past_corrs <- bind_rows(lapply(past_data, find_corrs_fhs, risk_factors), 
                        .id="whichPast") %>%
  mutate(whichPast=factor(whichPast, levels=c(paste0("exam",1:7), 
                                              "cumulative", "current")),
         rf=factor(rf, levels=risk_factors)) %>%
  filter(module %in% c("brown4", "blue", "lavenderblush3"))
```

```{r risk-factor-correlation-plot-data, warning=F}
corr_limits <- range(c(mod_rf_corrs_whi$corr, past_corrs$corr), na.rm=T)

current_corrs <- past_corrs %>%
  filter(whichPast == "current") %>%
  select(-whichPast) %>%
  bind_rows(mod_rf_corrs_whi, .id="study") %>%
  mutate(study=ifelse(study == 1, "FHS", "WHI"),
         rf=factor(rf, levels=risk_factors)) %>%
  filter(module %in% c("brown4", "blue"))
```

Next, we examined correlations between these module eigenCpGs and traditional cardiovascular risk factors. Though no extremely strong module-risk factor correlations were observed (all |r|<0.25), they tended to be stronger for the brown4 module, especially in FHS (Fig. 3a). Age showed the greatest association, while lipid and glycemic parameters also showed moderate associations. To further probe relationships between the brown4 module and risk factors in FHS, we retrieved historical risk factors measured in previous Offspring Cohort exams. Visual inspection revealed a notably stronger correlation between the module eigenCpG and cumulative (mean of all previous exams) compared to current risk factor exposure. This pattern applied for systolic blood pressure (strongly), triglycerides, glucose, BMI, and LDL (which correlated in the "expected" direction cumulatively, but non-intuitively at Exam 8) (Fig. 3b).

To better investigate this phenomenon, we tested associations between the brown4 module and each of the cumulative risk factors after adjustment for potential confounders. Specifically, for each risk factor, linear models were used to predict the brown4 eigenCpG value from either the current or cumulative risk factor level while adjusting for the full set of EWAS covariates other than BMI (age/sex/smoking/cell counts/study center/7 ctrl-probe PCs). Only for the brown4 module did cumulative risk factor exposure show strong associations, which were generally equal to or stronger than those of the current risk factors, most notably for BMI, hsCRP, and triglycerides (Table 4). Though more recent medication use could possibly explain discrepancies between biological relationships with current and past risk factors, adjustment for hypertension and lipid medication use did not notably affect the results of these models.

```{r cumulative-adjusted}
format_pvalues_epi <- function(p) {
  # "Epidemiology-style" p-value formatting
  ifelse(p < 0.001, "<0.001", 
         ifelse(p < 0.1, round(p, 3), round(p, 2)))
} 

fhs_covars_string <- paste(c("age", "sex", "smk_now", "smk_py", 
                             "CD4T", "CD8T", "NK", "Bcell", "Mono", "Gran", 
                             "center", "cpPC1", "cpPC2", "cpPC3", 
                             "cpPC4", "cpPC5", "cpPC6", "cpPC7"),
                           collapse=" + ")

rf_with_past <- risk_factors[!(risk_factors %in% c("age", "smk_now", "smk_py"))]
cum_adj_brown4 <- sapply(setNames(rf_with_past, rf_with_past), function(crf) {
  cum_data$cumRf <- scale(cum_data[[paste0(crf,".cum")]])
  cum_data$currRf <- scale(cum_data[[paste0(crf,".curr")]])
  cum_data$brown4 <- scale(fhs_ECs$brown4)
  formula_string <- paste0("brown4 ~ currRf + ", fhs_covars_string)
  lm_curr_fit <- lm(as.formula(paste0("brown4 ~ currRf + ", fhs_covars_string)), 
                    data=cum_data)
  lm_cum_fit <- lm(as.formula(paste0("brown4 ~ cumRf + ", fhs_covars_string)),
                   data=cum_data)
  unname(c(summary(lm_curr_fit)$coef["currRf", c(1, 4)], 
           summary(lm_cum_fit)$coef["cumRf", c(1, 4)]))
})

cum_adj_blue <- sapply(setNames(rf_with_past, rf_with_past), function(crf) {
  cum_data$cumRf <- scale(cum_data[[paste0(crf,".cum")]])
  cum_data$currRf <- scale(cum_data[[paste0(crf,".curr")]])
  cum_data$blue <- scale(fhs_ECs$blue)
  lm_curr_fit <- lm(as.formula(paste0("blue ~ currRf + ", fhs_covars_string)),
                    data=cum_data)
  lm_cum_fit <- lm(as.formula(paste0("blue ~ cumRf + ", fhs_covars_string)),
                   data=cum_data)
  unname(c(summary(lm_curr_fit)$coef["currRf", c(1, 4)], 
           summary(lm_cum_fit)$coef["cumRf", c(1, 4)]))
})

format_cumulative_table <- function(res) {
  t(res) %>%
    data.frame() %>%
    rownames_to_column() %>%
    setNames(c("Risk factor", "beta_current", "p_current", 
               "beta_cum", "p_cum")) %>%
    mutate(Current=paste0(signif(beta_current, 2), 
                          " (", signif(p_current, 2), ")"),
           Cumulative=paste0(signif(beta_cum, 2), 
                             " (", signif(p_cum, 2), ")")) %>%
    dplyr::select(`Risk factor`, Current, Cumulative)
}

mod_cum_tbl <- cbind(format_cumulative_table(cum_adj_brown4),
                     format_cumulative_table(cum_adj_blue)[-1])

kable(mod_cum_tbl, booktabs=T, longtable=T,
      caption=paste0("Module-risk factor relationships (current and ",
                     "cumulative) after adjustment for covariates")) %>%
  kable_styling(full_width=T) %>%
  add_header_above(c("", "brown4"=2, "blue"=2)) %>%
  footnote(number=c("Regression results are presented as: beta (p-value).",
                    paste0("Models are adjusted for age, sex, smoking status ",
                           "and pack-years, estimated cell counts, study ",
                           "center, and 7 control probe ",
                           "principal components.")), 
                    threeparttable=T)
```

Finally, we used the basic mediation approach of Baron and Kenny [@Baron1986] to test whether brown4 module activation may mediate a portion of the effects of cumulative risk factor exposure on cardiovascular risk. A series of Cox models were created in FHS for these three most strongly-associated risk factors (BMI, hsCRP, and triglycerides). Covariates in all models included current values for the risk factor in question, as well as technical factors, estimated cell counts, age, and sex. Current risk factors did not show notable relationships with incident CVD in any of the models. Having established the exposure-mediator relationships (Table 4), we tested the association with CVD risk of 1) cumulative risk factors, 2) module eigenCpGs, and 3) both quantities together (Table 5; example causal diagram using hsCRP in Supp. Fig. S4). In general, the significance of the module relationships with CVD tended to decrease in the presence of cumulative risk factor values. This fits with a model in which, rather than mediating cardiovascular risk, module activation acts as a biomarker for the actions of cumulative risk factor exposures by some other mechanism. As only subjects with current risk factor values were included in each model, sample sizes were largely identical across models.

```{r module-mediation, message=F}
rf_with_past <- risk_factors[!(risk_factors %in% c("age", "smk_now", "smk_py"))]

rf_only <- sapply(setNames(rf_with_past, rf_with_past), function(crf) {
  cum_data$cumRf <- cum_data[[paste0(crf, ".cum")]]
  cum_data$currRf <- cum_data[[paste0(crf, ".curr")]]
  cox_fit <- coxph(as.formula(paste0("Surv(time, event) ~ cumRf + currRf + ", 
                                     fhs_covars_string)), data=cum_data)
  unname(c(summary(cox_fit)$coef["currRf", c("coef", "Pr(>|z|)")], 
           summary(cox_fit)$coef["cumRf", c("coef", "Pr(>|z|)")]))
})

mod_alone <- sapply(setNames(rf_with_past, rf_with_past), function(crf) {
  cum_data$mod <- fhs_ECs$brown4
  cum_data$currRf <- cum_data[[paste0(crf,".curr")]]
  cox_fit <- coxph(as.formula(paste0("Surv(time, event) ~ mod + currRf + ", 
                                     fhs_covars_string)), data=cum_data)
  format_pvalues_epi(summary(cox_fit)$coef["mod", c("coef", "Pr(>|z|)")])
})

cum_with_mod <- sapply(setNames(rf_with_past, rf_with_past), 
                       function(crf) {
  cum_data$cumRf <- cum_data[[paste0(crf,".cum")]]
  cum_data$currRf <- cum_data[[paste0(crf,".curr")]]
  cum_data$mod <- fhs_ECs$brown4
  cox_fit <- coxph(as.formula(paste0(
    "Surv(time, event) ~ mod + cumRf + currRf + ", fhs_covars_string)), 
    data=cum_data)
  unname(c(summary(cox_fit)$coef["cumRf", c("coef", "Pr(>|z|)")], 
           summary(cox_fit)$coef["mod", c("coef", "Pr(>|z|)")]))
})

format_mod_rf_cvd_table <- function(res) {
  t(res) %>%
    data.frame(stringsAsFactors=F) %>%
    rownames_to_column() %>%
    setNames(c("Risk factor", "beta", "p")) %>%
    mutate(beta_p=paste0(signif(beta, 2), " (", 
                         format_pvalues_epi(p), ")")) %>%
    dplyr::select(`Risk factor`, beta_p)
}

mod_rf_cvd_tbl <- cbind(format_mod_rf_cvd_table(rf_only[3:4, ]),
                        format_mod_rf_cvd_table(mod_alone)[-1],
                        format_mod_rf_cvd_table(cum_with_mod[1:2, ])[-1],
                        format_mod_rf_cvd_table(cum_with_mod[3:4, ])[-1]) %>%
  set_tidy_names() %>%
  filter(`Risk factor` %in% c("bmi", "tg", "hscrp")) %>%
  setNames(c("Risk factor", "Cumulative", "Module", "Cumulative", "Module"))

kable(mod_rf_cvd_tbl, booktabs=T,
      caption=paste("CVD risk models using cumulative risk factor",
                    "exposure and brown4 module activation")) %>%
        add_header_above(c("", "Risk factors only", "Brown4 only", 
                           "Full model"=2)) %>%
        footnote(number="Regression results are presented as: beta (p-value).")
```


```{r save-for-supp}
save("ec_res", "nmd_fhs", "fhs_ECs", "fhs_res",
     "whi_mod_res_ccAdj_df", "whi_mod_res_allAdj_df", 
     "fhs_mod_res_df", "fhs_mod_res_allAdj_df", "fdr_tbl",
     "eforge_plt", file="../doc/module_ewas/for_supp_info.RData")
```

# Discussion

Here, we performed a primarily module-based epigenetic analysis of incident cardiovascular events in order to find robust, prospective biomarkers and uncover novel mechanisms contributing to disease risk. We began by constructing correlation-based clusters in the methylation data from WHI using the WGCNA algorithm. This network-based feature clustering approach can potentially improve the signal-to-noise ratio of high-dimensional DNA methylation data while facilitating more clear biological interpretation of results [@Langfelder2008]. As WGCNA does not consider class labels (i.e. incident CVD status), the `r length(mod_cpgs)` modules uncovered were not *a priori* expected to be related to CVD and rather reflected unbiased patterns in the data. After correction for multiple testing, the first principal components (eigenCpGs) of three of these modules were found to be related to incident cardiovascular events. A gene ontology-based enrichment analysis of the genes annotated to these modules found strong enrichment for either immune-related or development-related processes. The finding of immune-related processes is intuitive given that DNA from blood measures primarily immune cells, while the development-related enrichment could possibly reflect influences during early life [@Hao2018]. Notably, these two module "types" (immune and development) have been uncovered in a prior network-based DNA methylation analysis related to asthma [@Busch2016], suggesting that similar module types are a potentially general feature of blood-based methylation patterns and that these patterns may not be fully cardiovascular-specific, reflecting instead a predisposition toward general inflammatory disease processes. Both in WHI and in replication in FHS, two modules (blue and brown4) showed strong relationships with incident CVD that were attenuated after adjustment for age (direct correlations of these modules with age are presented in Fig. 3).

We examined the set of module eigenvector loadings as a proxy for the relative importance of their component CpGs, in a similar approach to the standard calculation of gene-module correlations (or "kME" statistics) in WGCNA analyses. As we did not observe any obvious peaks distinguishing particularly important groups of CpGs, we undertook an epigenome-wide association study (EWAS) in order to identify potentially stronger locus-specific signals. Though we did not find any single sites replicating in FHS after stringent correction for multiple tests, a subsequent region-based analysis using the Comb-p algorithm revealed three regions replicating strongly across the two cohorts examined here. One was found on chromosome 1 in the body of the SLC9A1 (also known as NHE-1) gene, which codes for an integral membrane ion transporter involved in intracellular pH maintenance. SLC9A1 has been shown to be required for the increased adhesion, migration, and phagocytosis of oxidized LDL seen in monocytes in response to stimuli including leptin, adrenaline, and hyperglycemia [@Sarigianni2010]. Another region discovered was on chromosome 19 near the transcription start site (TSS) of SLC1A5, which codes for a neutral amino acid transporter. Though strong evidence does not yet exist linking SLC1A5 to cardiovascular mechanisms, its CpGs have shown associations with diabetes, blood pressure, and mortality [@Walaszczyk2018; @Richard2017; @Zhang2017], and we note that its companion amino acid transporter, SLC7A5, is known to regulate metabolic and inflammatory reprogramming of monocytes in response to stimulation by lipopolysaccharide (LPS). Notably, CpG sites in both SLC9A1 and SLC1A5 were discovered and replicated in a recent EWAS for BMI (including the FHS cohort) [@Mendelson2017], though the specific SLC9A1 site from that study was not one of the three constituent CpGs in the region found here. These two SLC transporter DMRs contained CpGs belonging to blue (1 in SLC9A1) and brown4 (1 in SLC9A1, 5 in SLC1A5) modules. The third region was found near the TSS of TNRC6C on chromosome 17. This gene codes for a component of the miRNA-mediated translational repression cascade, has shown up in a genome-wide association study (GWAS) for heart failure (not one of the phenotypes included in our CVD definition here) [@Villard2011], and was identified as a potential target gene in the monocyte-to-macrophage transition upon exposure to CSF-1[@Wallner2016]. Common to these three DMRs is a potential involvement in monocyte biology specific to a stimulus response. This concept of "priming" for subsequent response to stimulus has been observed with respect to both monocyte activity in CVD [@Short2017] and DNA methylation in general [@Lam2012].

Based on the module- and region-level replication in FHS, we further explored the characteristics of the brown4 and blue modules. Enrichment analyses of gene-based and locus-based annotations demonstrated that these two modules occupy distinct biological niches. Broadly, the brown4 module (consisting of about 1000 CpG sites) is enriched for enhancers and other non-proximal regions near immune-related genes, while the blue module (a notably large module of almost 30,000 CpG sites) is enriched for CpG islands near the TSS of development-related genes. One could speculate that these modules also represent different mechanisms of cardiovascular risk: one related to inflammatory burden and the other to long-term effects of early-life exposures, both of which are well-established as contributing to cardiovascular risk [@Nahrendorf2018; @Hao2018]. Analyses based on cross-tissue epigenome annotations added an additional dimension to these insights by suggesting differential importance of blood cell sub-types for these modules. A cell type specificity analysis, adapted from the eFORGE algorithm [@Breeze2016], revealed the enrichment of monocyte-specific regions of open chromatin (DNase hypersensitivity sites and H3K4me1 peaks) in the brown4 module. This observation reinforces the idea of monocyte-specific activity suggested by the replicated DMRs as well as that of "monocyte priming" [@Short2017]. Based on the tendency of blue module CpGs to be proximal to gene TSS, we focused on enrichment for a promoter-associated marker, H3K4me3, and found a distinct signal related to hematopoietic stem cells. This finding supports a potential mechanism linking early-life exposure to consequences in adult life [@Farlik2016;@Laiosa2015]. We also observed that the blue module was strongly enriched for components of a popular epigenetic age marker [@Horvath2013] as well as for binding regions of the Polycomb-group member SUZ12. As Polycomb-group targets are known to be related to developmental processes [@Dozmorov2015], this finding contributes additional support to the module's role as a bridge between development, aging, and disease risk.

<!--
In seeking a specific example of the mechanism by which the development-related blue module may by related to CVD risk, we found a single gene, PDE3A, which is in the blue module's top GO terms, is annotated to highly-weighted sites in the blue eigenCpG, and is near to a metastable epiallele found by Kessler et al. to be environmentally sensitive in developing embryos [@Kessler2018]. PDE3A, encoding for an isoform of phosphodiesterase 3, is highly expressed in the arteries and heart, has been linked to cardiovascular disease through its role in regulating vascular smooth muscle cell contraction. Six missense variants located in PDE3A have been previously identified as responsible for Mendelian hypertension, and murine models have suggested that increases in PDE3 activity may mediate some of the accelerated atherosclerosis observed in diabetes [@Maass2015;@Nagaoka1998]. Interestingly, PDE3A downregulation is potentially related specifically to heart failure, an outcome that was not included in our definition of CVD for this study[@Yan2007].
-->

It is not clear whether these methylation modules associate with cardiovascular risk upstream, downstream, or independently of traditional cardiovascular risk factors (including age, blood pressure, BMI, smoking, and lipid levels). To explore these relationships, we began by calculating correlations between risk factor levels and blue and brown4 module activations. Blue correlations were largely weak, while brown4 correlations were somewhat stronger, following the hypothesis that the blue module is more relevant to early-life, rather than adult, exposures as compared to brown4. However, as a semi-stable biological quantity, methylation may have the ability to act as a "molecular recorder" of past exposures, ranging from heavy metals to stress [@Wright2010; @Matosin2017]. We thus retrieved risk factor measurements from seven prior exams in FHS to compare "cumulative" (calculated as the mean of past exam values) versus current correlations with brown4 activation. Surprisingly, we observed stronger correlations with cumulative values across almost all risk factors. To address the possibility of confounding in these relationships, we tested linear models predicting brown4 eigenCpG values from current or cumulative risk factors adjusting for the full set of EWAS covariates. Here, we again observed multiple instances of stronger cumulative relationships, especially for BMI, hsCRP, and triglycerides. Though such a finding could be partially explained by the greater stability in a mean over seven values compared to one, we note that we did not observe this same pattern with respect to the blue module, where associations with current risk factors tended to be stronger. Our observation agrees with a conceptual model in which known risk factors, such as the three noted here, act partially through their cumulative impact over time on immune cell DNA methylation and thus inflammatory processes known to be related to CVD pathogenesis. 

To more directly test this proposal, we used a basic mediation approach in which we sequentially tested the relationships between cumulative risk factor levels, brown4 eigenCpG values, and both factors together in predicting incident CVD. Though neither factor exerted a strong effect on the relationship of the other, module activation associations were more weakened after adjustment for cumulative risk factors than the converse. Thus, our models replicate previous findings that cumulative risk factor exposure correlates with CVD risk [@Reinikainen2015] while suggesting that brown4 methylation module activation may be sensing, rather than mediating, this effect. One concrete example supporting this observation is the DMR near SLC1A5 containing primarily brown4 CpGs, one of which (cg02711608) was suggested in Mendelian randomization analysis to be causally downstream of blood pressure [@Richard2017].

A few limitations should be acknowledged in intepreting the results of this study. First, its observational nature made it impossible to clearly determine causality of the relationships between methylation and cardiovascular risk. While the examination of incident CVD reduced concerns about reverse causation, the discovered associations may only be markers of other disease-causing processes (such as cumulative risk factor exposure, as discussed above). Second, assessment of methylation in blood samples prevented the understanding of potentially causal epigenetic effects in other CVD-relevant tissues. Although some studies report promising findings with respect to blood as a proxy tissue [@Bacos2016; @Huang2016], and although development-related epialleles may persist across tissues, there is a certain gap in our ability to discover non-blood-related epigenetic patterns in this analysis. Finally, longitudinal methylation measurements were not available in these datasets, preventing an analysis of the intra-individual stability of methylation sites and modules that may be predictive of CVD risk.

The modules and regions discovered in this investigation provide insights into the complex relationships between DNA methylation and cardiovascular disease risk. We show that epigenetic modules track with diverse biological sources of CVD risk, ranging from development- to immune-related processes, and may provide a molecular readout of past exposure to cardiovascular risk factors. We further discover specific differentially methylated regions that may be related to monocyte activation in response to biological stimuli. This work opens the door to further investigation of the epigenetic basis of CVD risk as well as the ability of DNA methylation to act as a biomarker of prior exposures that may be important for disease-relevant prognosis and interventions.

# Methods
    
## Study participants and phenotype collection

Data for the discovery set came from a combined case-control and pseudo case-cohort sampling of 2129 women from the Women's Health Initiative study, a larger prospective cohort beginning in 1993 that included over 160,000 postmenopausal women from across the United States[@Anderson1998]. Included subjects had no self-reported CVD at baseline, and cases were chosen based on incident centrally adjudicated angina, revascularization, or CHD event during follow-up. Inclusion criteria for methylation measurement resulted in an oversampling of African American and Hispanic participants. Blood samples used for measurement of DNA methylation and clinical biochemistry were taken at Exam 1. Data are available in the dbGaP public repository (accession: phs000200.v11.p3; downloaded on September 27, 2017).

Data for the validation set came from a substudy of the Framingham Heart Study that measured DNA methylation in 2726 subjects from the Offspring Cohort. The Framingham Offspring Cohort was originally established in 1971 to follow 5209 children of the original Framingham Heart Study participants and their spouses[@Kannel1979]. Fasting blood samples for both methylation and clinical biochemistry were collected from participants at Exam 8, which took place from 2005-8. Blood samples were also provided for clinical biochemistry measurements in previous exams, constituting the "past exposures" examined here. Data are available in the dbGaP public repository (accession: phs000007.v29.p10; downloaded on September 27, 2017). Adjudicated cardiovascular event data was collected through 2015, and events were defined here as any of: myocardial infarction, angina pectoris, stroke, or death from CHD (Framingham event codes 1-29).

Blood-based biochemical markers (total cholesterol, LDL-C, HDL-C, triglycerides, glucose, hsCRP, and systolic blood pressure) were log10-transformed for all analyses. In addition, median imputation was used to fill missing values for BMI (20 individuals in total), medication use, and smoking status (thus assuming no medication use and no smoking where these values were missing). Diabetes was defined as either use of diabetes medication or a measured fasting blood glucose level of >125 mg/dL. While directly available in WHI, pack-years of smoking was approximated in FHS by multiplying the number of years since starting smoking by the current number of packs per day.

## DNA methylation data processing

In both cohorts, DNA methylation data were collected using the Illumina HumanMethylation450 microarray platform [@Bibikova2011] and downloaded as raw intensity files. Preprocessing was performed using the *minfi* and *wateRmelon* packages for R [@Aryee2014; @Pidsley2013]. As a quality control step, samples were removed if they showed weak overall signal based on visual inspection of an intensity plot, if they had more than 10% of probes undetected at a detection threshold of p<1e-16, or if the reported sex did not match the predicted sex based on methylation patterns. Probes were removed if they met any of the following criteria: more than 10% of samples undetected at a detection threshold of p<1e-16, location in the X or Y chromosomes, non-CpG probes, cross-hybridizing probes, probes measuring SNPs, and probes with an annotated SNP at the CpG site or in the single-base extension region. Samples were normalized using the Noob method for background correction and dye-bias normalization, followed by the BMIQ method for probe type correction [@Fortin2016; @Teschendorff2013]. For each dataset, principal components analysis was performed on the set of control probes using code adapted from the CPACOR method of Lehne et al. to account for technical variation [@Lehne2015]. Blood cell counts for 6 blood cell types (CD4+ T-cells, CD8+ T-cells, B-cells, natural killer cells, monocytes, and granulocytes) were estimated using a common reference-based method [@Houseman2012]. After quality control and filtering steps, `r nrow(betas_whi)` (WHI) and `r nrow(betas_fhs)` (FHS) CpG sites remained for downstream analysis, formatted as beta values (ratio of methylated signal to total microarray signal). The vast majority of these sites (422688) were available in both datasets.

<!--Visualization of the associations between top principal components for each dataset and major biological and technical variables was examined using heatmaps (Supp. Fig. \@ref(fig:supp-var-plots)). Based on these assessments as well as examination of Scree plots for CPACOR principal components, ___________________-->

## Weighted gene correlation network analysis

Weighted gene correlation network analysis (WGCNA) was used to find highly correlated modules of CpG sites [@Zhang2005]. The full set of `r length(wgcna_input_cpgs)` CpGs passing quality control from WHI were used as input. For computational tractability, blockwise module detection was performed, which treats blocks of features separately for network creation and module detection, followed by eventual merging of highly similar modules. To allow for reasonable computation time, the initial pre-clustering analysis (used to inform the choice of blocks) was performed in a random subset of 100 subjects. A block size of 20,000 was used, and a soft-thresholding power of 8 was chosen to balance approximately scale-free network properties with network connectivity. Unsigned networks were used, based on the fact that the biological consequences of an increase vs. decrease in DNA methylation are much less clear than those of gene transcripts. Whole-module behavior was assessed using the first component from a principal components analysis, performed separately for each module. Scree plots were used to inform the variance explained by each module as well as to justify the use of a single eigenvector as a proxy for module behavior. Module preservation assessment was completed in FHS to confirm cross-dataset robustness of modules. The *modulePreservation* function calculates permutation-based $Z_{summary}$ statistics reflecting the preservation of density (of within-module adjacencies) and connectivity (maintenance of within-module node correlations) when modules are evaluated in a test set [@Langfelder2011]. EigenCpGs were then calculated (according to the principal component weights from WHI), followed by assessment of associations with incident CVD.

Module associations with cardiovascular disease were assessed using Cox proportional hazards regressions, with eigenCpGs as the independent variable and time-to-event measures for incident CVD as the dependent variable. Minimal models adjusted for estimated blood cell counts as well as technical covariates (DNA pull batch in WHI; analysis center + 7 control-probe principal components in FHS -- see EWAS section for details). Fully-adjusted models adjusted additionally for biological covariates (age, BMI, smoking status, and pack-years of smoking; sex in FHS; race in WHI). Proportional hazards checks were implemented (cox.zph function in R), and no violations of the Cox regression assumptions were detected at p < 0.05 for any of the modules in WHI or FHS. Mixed models to account for family structure in FHS were also explored, but were found to generate highly similar results (Supp. Table S1).

## Epigenome-wide associations of DNA methylation with incident CVD events

For the EWAS analysis, each CpG site was assessed using the the same regression framework as in the module-based models, separately in both WHI and FHS. Methylation beta-values replaced eigenCpGs as the independent variable, and the full set of technical and biological covariates was used. To remove the influence of beta-value outliers, samples were excluded for each CpG if their beta value was outside of the interval [25%ile - $3*IQR$, > 75%ile + $3*IQR$]. QQ plots and calculation of the genomic inflation factor $\lambda$ revealed that genomic inflation was not initially adequately controlled in FHS, but after additional adjustment for 7 CPACOR principal components (chosen based on a Scree plot assessment of CPACOR results), a reasonable inflation of $\lambda$ = 1.09 was achieved. CPACOR uses principal components analysis on the set of control probes from the methylation array in order to estimate and control for potential batch effects without disturbing biological signal [@Lehne2015]. Proportional hazards checks were implemented as in the module-based analysis for the top EWAS hits in WHI, and no systematic departure from the Cox regression assumptions were detected.

Comb-p, implemented as a Python module, was used to call differentially methylated regions (DMRs). The algorithm takes as input p-values from the EWAS, removing the requirement for additional covariate adjustment. Comb-p first calculates an autocorrelation function (ACF), for which a maximum distance of 1kb and a step size of 50 bases were used. Next, it uses the ACF to adjust each p-value using a Stouffer-Liptak-Kechris correction, followed by identification of contiguous regions of sites with adjusted p-values below some threshold (here, p<0.1 with no more than 500 bases between neighboring sites in a region). Finally, the ACF is recalculated out to the maximum region size (a step size of 50 was used here as well) and regional p-values are calculated using the Stouffer-Liptak test. For multiple testing correction of DMRs, Comb-p calculates the number of effective tests separately for each DMR as the number of loci tested divided by the size of the region (typically ~1kb).

DMRs were examined to evaluate whether their constituent CpGs contained any residual SNPs-under-probe that escaped filtering based on the Illumina HumanMethylation450 annotation. These checks were performed manually using the UCSC Genome Browser [@Kent2002] and a dbSNP-based annotation track displaying common (>=1% minor allele frequency) variants.

## Module enrichment analyses

Gene ontology-based enrichment analysis of modules was performed using the gometh function from the *missMethyl* package for R [@Phipson2015]. In this procedure, CpG sites are annotated to genes using the HumanMethylation450 microarray annotation from Illumina, resulting in a binary vector indicating whether each gene is associated with any of the CpG sites of interest (for example, CpGs constituting a module). Prior probabilities for each gene being selected are estimated based on the total number of associated CpG sites on the array. Enrichment analysis is then performed for each gene ontology category using Wallenius' noncentral hypergeometric distribution, which generalizes the basic hypergeometric distribution to account for biased sampling.

Locus-based enrichment analyses were performed using basic two-tailed hypergeometric tests for overlap between module membership and annotation category membership. CpG annotations with respect to both CpG islands (Island, North shore, Open sea, etc.) and genes (TSS1500, 3' UTR, Body, etc.) were retrieved from the standard Illumina HumanMethylation450 microarray annotation. CpG sites were annotated for Polycomb-group target status using embryonic stem cell SUZ12 binding regions retrieved from Lee et al. [@Lee2006].

## Inference of cell type specificity

Epigenomic annotations were used to test for relative enrichment of module CpGs in cell type-specific regulatory regions. Annotations for broad peaks in DNase sensitivity as well as ChIP-seq signal for H3K4me1 and H3K4me3 were obtained for 6 blood cell types (monocytes, natural killer cells, T-cells, B-cells, and hematopoietic stems cells from males and females) from the NIH Roadmap Epigenomics Project database [@KundajeAnshulMeuleman2015]. For each combination of epigenomic feature and cell type, CpGs from the HumanMethylation450 array were classified as to their membership in a peak region. Relative enrichments of in-peak CpGs for modules were then calculated as the ratio of $\frac{\#CpG_{in-peak}}{\#CpG_{total}}_{module}$ to $\frac{\#CpG_{in-peak}}{\#CpG_{total}}_{all}$ and presented as $log_2$(relative enrichment) for ease of visualization. Cell type specificity of different modules can then be compared by examining relative enrichments across cell types, especially with respect to highly-represented regulatory annotation types (e.g. DNase hypersensitivity sites for a module enriched in enhancers). We note that this method borrows from the permutation-based eFORGE tool methodology [@Breeze2016], which could not be used here due to the size of the blue module. However, we confirmed similarity of our results to those from the eFORGE method for the brown4 module (Supp. Fig. S3).

## Risk factor integration

Risk factors were incorporated into the module-based analysis in a series of steps. First, Pearson correlations between risk factor levels and module eigenCpGs were calculated to provide a high-level understanding of the strength of their relationship. Risk factors in WHI were all measured at Exam 1 (concurrently with the methylation measurement), while risk factors in FHS were collected for all exams prior to and including Exam 8 (the time of the methylation measurement). In FHS, correlations with past risk factor levels as well as a "cumulative" exposure level (equal to the mean of each set of risk factor levels from Exam 1-7) were also calculated.

Next, linear models were used to assess these same module-risk factor correlations in FHS while adjusting for potential confounding variables. These models predicted module eigenCpGs using either cumulative (Exams 1-7) or current (Exam 8) risk factors, while adjusting for the same set of technical and biological covariates as in the EWAS (described above). In this step, both eigenCpGs and risk factors were standardized before modeling in order to facilitate effect size comparisons across risk factors and across modules.

Finally, the relationship between cumulative risk factors, the brown4 module, and incident CVD was examined, using the same Cox regression setup as in the EWAS to perform a basic mediation analysis for BMI, hsCRP, and triglycerides. Here, cumulative risk factor exposure (as defined above) acted as the exposure, brown4 methylation module activation (represented by the brown4 eigenCpG) acted as the mediator, and incident CVD acted as the outcome. Having established the strong exposure-mediator links, three subsequent Cox models were examined: cumulative risk factors only, brown4 eigenCpG only, and both simultaneously. All models adjusted for the full set of technical and biological covariates as well as the "current" level (i.e. at Exam 8) of the risk factor in question.


# References

<div id="refs"></div>

```{r print-combp-plots, fig.asp=1.2, fig.cap="DMRs identified by Comb-p in WHI and validated in FHS at the (a) SLC9A1, (b) SLC1A5, and (c) TNRC6C loci. Negative logarithms of EWAS p-values are shown as a function of the genomic coordinate. EWAS p-values from WHI are in red and FHS in green. Dotted lines demarcate the DMR boundaries."}
plot_grid(slc9a1_plt, slc1a5_plt, tnrc6c_plt, nrow=3, labels=c("a", "b", "c"))
```

```{r brown-and-blue-plots, fig.asp=1.6, fig.cap="Genomic and epigenomic annotations of the brown4 and blue modules. a,b) Relative proportions of module CpGs compared to the full set of CpGs tested, with respect to gene-based (a) or CpG island-based (b) annotations (UTR = untranslated region; TSS_X = sites within X base pairs upstream of the gene transcription start site). c) Cell type-specific enrichments based on Roadmap Epigenomics datasets. Shown are relative enrichments of peaks (ratio of in-module fraction to all-CpG fraction) for a given epigenetic mark across many blood cell types, for each of the modules of interest.", warning=F}
gene_enrich_plots <- plot_grid(brown4_gene_group_enrichment_plot + 
                                 scale_y_continuous(limits=c(0,0.5)) + 
                                 theme(legend.position="none") + 
                                 labs(y="Brown CpG fractions"),  # Brown4 --> Brown
                               blue_gene_group_enrichment_plot + 
                                 scale_y_continuous(limits=c(0,0.5)) + 
                                 theme(legend.title=element_blank()) + 
                                 labs(y="Blue Cpg fractions"), 
                               ncol=2, rel_widths=c(3,5))
cpgi_enrich_plots <- plot_grid(brown4_cpg_island_enrichment_plot + 
                                 scale_y_continuous(limits=c(0,0.65)) + 
                                 theme(legend.position="none") + 
                                 labs(y="Brown CpG fractions"),  # Brown4 --> Brown
                               blue_cpg_island_enrichment_plot + 
                                 scale_y_continuous(limits=c(0,0.65)) + 
                                 theme(legend.title=element_blank()) + 
                                 labs(y="Blue CpG fractions"), 
                               ncol=2, rel_widths=c(3,5))
epi_anno_plt_data$module <- factor(epi_anno_plt_data$module,
                                   levels=c("brown4", "blue"),
                                   labels=c("Brown", "Blue"))
roadmap_plt <- ggplot(epi_anno_plt_data, 
                     aes(x=epiFeature, y=forcats::fct_rev(cellType), 
                         fill=negLogP)) +
  geom_tile(color="gray") +
  scale_fill_gradient2(low="blue", mid="white", high="red", 
                       name="log2(rel. enrichment)") +
  theme(axis.title.y=element_blank(), axis.text.y=element_text(size=9), 
        axis.ticks.y=element_blank(), axis.title.x=element_blank(), 
        axis.text.x=element_text(angle=20), axis.line=element_blank(),
        legend.position="top", legend.text=element_text(size=9), 
        panel.background=element_blank()) +
  facet_wrap(~module)
roadmap_plt_axis_switch <- roadmap_plt + scale_y_discrete(position="right")
plot_grid(gene_enrich_plots, cpgi_enrich_plots, roadmap_plt_axis_switch,
          labels=c("a", "b", "c"), nrow=3, rel_heights=c(2, 2, 3))
```

```{r risk-factor-correlation-plots, fig.cap="Risk factor-module relationships. (a) Pearson correlations between a series of traditional cardiovascular risk factors and module eigenCpGs (blue and brown4) are shown in each study population. (b) Pearson correlations between historical risk factor levels in FHS (across previous exams, x-axis) and current brown4 module activation are shown. Grey panels indicate that the risk factor in question was not available for the corresponding exam."}
current_corrs$module <- factor(current_corrs$module,
                               levels=c("brown4", "blue"),
                               labels=c("Brown", "Blue"))
rf_corr_plt <- ggplot(current_corrs, aes(x=study, y=rf, fill=corr)) +
  geom_tile() +
  scale_fill_gradient2(name="Correlation", limits=corr_limits, guide=F) +
  theme(axis.title=element_blank(), axis.line=element_blank(),
        axis.text=element_text(size=10), 
        axis.text.x=element_text(angle=30, hjust=0.75)) +
  facet_wrap(~module)

fhs_rf_corr_plt_data <- past_corrs %>%
  filter(module == "brown4") %>%
  mutate(module="Brown")
fhs_rf_corr_plt <- ggplot(fhs_rf_corr_plt_data, 
                          aes(x=whichPast, y=rf, fill=corr)) +
  geom_tile() +
  scale_fill_gradient2(name="Correlation", limits=corr_limits) +
  theme(axis.title=element_blank(), 
        axis.text.x=element_text(size=9, angle=30, hjust=0.75), 
        axis.text.y=element_blank(), axis.ticks.y=element_blank(),
        axis.line=element_blank()) +
  facet_wrap(~module)

plot_grid(rf_corr_plt, fhs_rf_corr_plt, nrow=1, rel_widths=c(2,3), 
          align="h", axis="bt", labels=c("a", "b"))
```